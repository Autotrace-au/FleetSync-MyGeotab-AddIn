<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetSync Property Manager</title>
</head>
<body>
    <script>
        // Inject CSS dynamically to bypass MyGeotab's style tag stripping
        (function() {
            const css = `
/* Scoped CSS for MyGeotab Add-In - All selectors prefixed with #fleetSyncAddin */
#fleetSyncAddin {
    /* CSS Variables scoped to the add-in */
    --primary-color: #2563eb;
    --primary-dark: #1e40af;
    --primary-light: #3b82f6;
    --success-color: #10b981;
    --success-dark: #059669;
    --warning-color: #f59e0b;
    --warning-dark: #d97706;
    --error-color: #ef4444;
    --error-dark: #dc2626;
    --info-color: #06b6d4;
    --info-dark: #0891b2;
    --secondary-color: #64748b;
    --secondary-dark: #475569;
    --light-bg: #f8fafc;
    --card-bg: #ffffff;
    --border-color: #e2e8f0;
    --text-color: #0f172a;
    --text-muted: #64748b;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    font-size: 14px;
    line-height: 1.6;
    color: var(--text-color);
    background-color: #f1f5f9;
    min-height: 100vh;
    box-sizing: border-box;
}
#fleetSyncAddin *, #fleetSyncAddin *::before, #fleetSyncAddin *::after { box-sizing: border-box; }
#fleetSyncAddin .container { max-width: 100%; margin: 0; background-color: var(--card-bg); min-height: 100vh; }
#fleetSyncAddin header { background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); color: white; padding: 32px 40px; position: relative; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
#fleetSyncAddin header::before { content: ''; position: absolute; top: -50%; right: -10%; width: 300px; height: 300px; background: rgba(255, 255, 255, 0.08); border-radius: 50%; }
#fleetSyncAddin .header-content { max-width: 900px; margin: 0 auto; }
#fleetSyncAddin header h1 { font-size: 32px; font-weight: 700; margin-bottom: 8px; position: relative; z-index: 1; }
#fleetSyncAddin .subtitle { font-size: 16px; opacity: 0.9; position: relative; z-index: 1; }
#fleetSyncAddin .content-wrapper { padding: 30px 40px; max-width: 900px; margin: 0 auto; }
#fleetSyncAddin #assetsTab { max-width: 1400px; }
#fleetSyncAddin section { margin-bottom: 30px; padding: 24px; background-color: var(--light-bg); border-radius: 12px; border: 1px solid var(--border-color); transition: all 0.3s ease; }
#fleetSyncAddin section:hover { box-shadow: var(--shadow-md); }
#fleetSyncAddin section h2 { font-size: 20px; font-weight: 700; margin-bottom: 16px; color: var(--text-color); display: flex; align-items: center; gap: 10px; }
#fleetSyncAddin section h2::before { content: ''; width: 4px; height: 24px; background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); border-radius: 2px; }
#fleetSyncAddin .info-text { color: var(--text-muted); margin-bottom: 20px; line-height: 1.7; }
#fleetSyncAddin .status-section { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-color: #bae6fd; }
#fleetSyncAddin .status-message { padding: 16px 20px; border-radius: 10px; font-weight: 500; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow-sm); animation: slideIn 0.3s ease; }
@keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
#fleetSyncAddin .status-message svg { max-width: 20px; max-height: 20px; flex-shrink: 0; display: block; }
#fleetSyncAddin .status-info { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e40af; border: 1px solid #93c5fd; }
#fleetSyncAddin .status-info svg { stroke: #1e40af; fill: none; }
#fleetSyncAddin .status-success { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46; border: 1px solid #6ee7b7; }
#fleetSyncAddin .status-success svg { stroke: #065f46; fill: none; }
#fleetSyncAddin .status-warning { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e; border: 1px solid #fcd34d; }
#fleetSyncAddin .status-warning svg { stroke: #92400e; fill: none; }
#fleetSyncAddin .status-error { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #991b1b; border: 1px solid #fca5a5; }
#fleetSyncAddin .status-error svg { stroke: #991b1b; fill: none; }
#fleetSyncAddin .property-list { display: grid; gap: 16px; }
#fleetSyncAddin .property-item { display: flex; align-items: flex-start; padding: 20px; background-color: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); transition: all 0.3s ease; box-shadow: var(--shadow-sm); }
#fleetSyncAddin .property-item:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); border-color: var(--primary-light); }
#fleetSyncAddin .property-icon { width: 48px; height: 48px; margin-right: 18px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #e0e7ff 0%, #ddd6fe 100%); border-radius: 12px; padding: 10px; }
#fleetSyncAddin .property-icon svg { max-width: 28px; max-height: 28px; stroke: var(--primary-color); display: block; }
#fleetSyncAddin .property-details { flex: 1; }
#fleetSyncAddin .property-details h3 { font-size: 17px; font-weight: 600; margin-bottom: 8px; color: var(--text-color); }
#fleetSyncAddin .property-details p { font-size: 14px; color: var(--text-muted); margin-bottom: 12px; line-height: 1.6; }
#fleetSyncAddin .property-status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; background-color: var(--light-bg); color: var(--text-muted); border: 1px solid var(--border-color); transition: all 0.2s ease; }
#fleetSyncAddin .property-status-badge.status-exists { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46; border-color: #6ee7b7; }
#fleetSyncAddin .property-status-badge.status-missing { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e; border-color: #fcd34d; }
#fleetSyncAddin .actions-section { display: flex; gap: 12px; flex-wrap: wrap; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); padding: 24px; border: 1px solid var(--border-color); }
#fleetSyncAddin .btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; font-size: 14px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; text-decoration: none; box-shadow: var(--shadow-sm); position: relative; overflow: hidden; }
#fleetSyncAddin .btn svg { max-width: 18px; max-height: 18px; stroke: currentColor; display: block; }
#fleetSyncAddin .btn::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%; background: rgba(255, 255, 255, 0.3); transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s; }
#fleetSyncAddin .btn:hover:not(:disabled)::before { width: 300px; height: 300px; }
#fleetSyncAddin .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
#fleetSyncAddin .btn:active:not(:disabled) { transform: translateY(0); }
#fleetSyncAddin .btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }
#fleetSyncAddin .btn-primary { background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); color: #ffffff; }
#fleetSyncAddin .btn-primary:hover:not(:disabled) { background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-color) 100%); }
#fleetSyncAddin .btn-success { background: linear-gradient(135deg, var(--success-color) 0%, var(--success-dark) 100%); color: #ffffff; }
#fleetSyncAddin .btn-success:hover:not(:disabled) { background: linear-gradient(135deg, #34d399 0%, var(--success-color) 100%); }
#fleetSyncAddin .btn-secondary { background: linear-gradient(135deg, var(--secondary-color) 0%, var(--secondary-dark) 100%); color: #ffffff; }
#fleetSyncAddin .btn-secondary:hover:not(:disabled) { background: linear-gradient(135deg, #94a3b8 0%, var(--secondary-color) 100%); }
#fleetSyncAddin .help-section { background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); border-color: #c4b5fd; }
#fleetSyncAddin .help-section ul { margin-left: 20px; margin-top: 12px; margin-bottom: 12px; }
#fleetSyncAddin .help-section li { margin-bottom: 8px; color: var(--text-color); }
#fleetSyncAddin .help-link { margin-top: 16px; }
#fleetSyncAddin .help-link a { color: var(--primary-color); text-decoration: none; font-weight: 600; transition: all 0.2s ease; border-bottom: 2px solid transparent; }
#fleetSyncAddin .help-link a:hover { color: var(--primary-dark); border-bottom-color: var(--primary-color); }
#fleetSyncAddin .tab-navigation { display: flex; gap: 0; background-color: var(--card-bg); border-bottom: 2px solid var(--border-color); padding: 0 40px; margin: 0; box-shadow: var(--shadow-sm); }
#fleetSyncAddin .tab-button { padding: 16px 24px; font-size: 15px; font-weight: 600; color: var(--text-muted); background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; transition: all 0.3s ease; position: relative; }
#fleetSyncAddin .tab-button:hover { color: var(--primary-color); background-color: var(--light-bg); }
#fleetSyncAddin .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); background-color: var(--light-bg); }
#fleetSyncAddin .tab-content { display: none; }
#fleetSyncAddin .tab-content.active { display: block; }
#fleetSyncAddin .asset-table-container { overflow-x: auto; background-color: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); }
#fleetSyncAddin .asset-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
#fleetSyncAddin .asset-table thead { background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); color: white; }
#fleetSyncAddin .asset-table th { padding: 10px 8px; text-align: left; font-weight: 600; font-size: 12px; white-space: nowrap; }
#fleetSyncAddin .asset-table td { padding: 8px; border-bottom: 1px solid var(--border-color); font-size: 12px; }
#fleetSyncAddin .asset-table tbody tr:hover { background-color: var(--light-bg); }
#fleetSyncAddin .asset-table tbody tr:last-child td { border-bottom: none; }
#fleetSyncAddin .asset-table th:nth-child(1), #fleetSyncAddin .asset-table td:nth-child(1) { width: 50px; text-align: center; }
#fleetSyncAddin .asset-table th:nth-child(2), #fleetSyncAddin .asset-table td:nth-child(2) { width: 180px; }
#fleetSyncAddin .asset-table th:nth-child(3), #fleetSyncAddin .asset-table td:nth-child(3) { width: 70px; text-align: center; }
#fleetSyncAddin .asset-table th:nth-child(4), #fleetSyncAddin .asset-table td:nth-child(4) { width: 70px; text-align: center; }
#fleetSyncAddin .asset-table th:nth-child(5), #fleetSyncAddin .asset-table td:nth-child(5) { width: 200px; }
#fleetSyncAddin .asset-table th:nth-child(6), #fleetSyncAddin .asset-table td:nth-child(6) { width: 200px; }
#fleetSyncAddin .asset-table th:nth-child(7), #fleetSyncAddin .asset-table td:nth-child(7) { width: 70px; text-align: center; }
#fleetSyncAddin .asset-table th:nth-child(8), #fleetSyncAddin .asset-table td:nth-child(8) { width: 90px; }
#fleetSyncAddin .asset-table th:nth-child(9), #fleetSyncAddin .asset-table td:nth-child(9) { width: 100px; }
#fleetSyncAddin .asset-table th:nth-child(10), #fleetSyncAddin .asset-table td:nth-child(10) { width: 90px; }
#fleetSyncAddin .asset-table th:nth-child(11), #fleetSyncAddin .asset-table td:nth-child(11) { width: 90px; text-align: center; }
#fleetSyncAddin .asset-table input[type="text"], #fleetSyncAddin .asset-table input[type="number"] { width: 100%; padding: 4px 6px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 12px; transition: all 0.2s ease; }
#fleetSyncAddin .asset-table input[type="text"]:focus, #fleetSyncAddin .asset-table input[type="number"]:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
#fleetSyncAddin .asset-table input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
#fleetSyncAddin .asset-table .asset-name { font-weight: 600; color: var(--text-color); font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
#fleetSyncAddin .asset-table .asset-serial { color: var(--text-muted); font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
#fleetSyncAddin .save-btn-cell { text-align: center; }
#fleetSyncAddin .btn-save { padding: 4px 12px; font-size: 11px; }
#fleetSyncAddin .group-assign-btn { background: none; border: none; cursor: pointer; padding: 4px; display: inline-flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s ease; }
#fleetSyncAddin .group-assign-btn:hover { background-color: var(--light-bg); }
#fleetSyncAddin .group-assign-btn svg { width: 20px; height: 20px; stroke: var(--secondary-color); }
#fleetSyncAddin .group-assign-btn:hover svg { stroke: var(--primary-color); }
#fleetSyncAddin .group-header-row { background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); transition: all 0.2s ease; }
#fleetSyncAddin .group-header-row:hover { background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%); }
#fleetSyncAddin .group-header-row td { padding: 12px 8px; font-weight: 700; font-size: 13px; color: var(--text-color); border-bottom: 2px solid var(--border-color); }
#fleetSyncAddin .group-header-content { display: flex; align-items: center; gap: 8px; flex: 1; cursor: pointer; }
#fleetSyncAddin .group-header-wrapper { display: flex; align-items: center; justify-content: space-between; width: 100%; }
#fleetSyncAddin .group-header-actions { display: flex; gap: 6px; }
#fleetSyncAddin .group-action-btn { background: none; border: none; cursor: pointer; padding: 4px 8px; display: inline-flex; align-items: center; gap: 4px; border-radius: 4px; transition: all 0.2s ease; font-size: 11px; font-weight: 600; }
#fleetSyncAddin .group-action-btn:hover { background-color: rgba(0, 0, 0, 0.05); }
#fleetSyncAddin .group-action-btn svg { width: 14px; height: 14px; }
#fleetSyncAddin .group-action-btn.edit-btn { color: var(--primary-color); }
#fleetSyncAddin .group-action-btn.edit-btn svg { stroke: var(--primary-color); }
#fleetSyncAddin .group-action-btn.delete-btn { color: var(--error-color); }
#fleetSyncAddin .group-action-btn.delete-btn svg { stroke: var(--error-color); }
#fleetSyncAddin .group-header-icon { transition: transform 0.3s ease; }
#fleetSyncAddin .group-header-icon.collapsed { transform: rotate(-90deg); }
#fleetSyncAddin .group-asset-row { background-color: var(--card-bg); }
#fleetSyncAddin .group-asset-row.hidden { display: none; }
#fleetSyncAddin .loading-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
#fleetSyncAddin footer { margin-top: 0; padding: 24px 40px; border-top: 1px solid var(--border-color); text-align: center; color: var(--text-muted); font-size: 12px; background-color: var(--light-bg); }
#fleetSyncAddin .footer-content { max-width: 900px; margin: 0 auto; }
@media (max-width: 768px) {
    #fleetSyncAddin { padding: 10px; }
    #fleetSyncAddin header { padding: 30px 20px; }
    #fleetSyncAddin .content-wrapper { padding: 20px; }
    #fleetSyncAddin section { padding: 16px; }
    #fleetSyncAddin .property-item { flex-direction: column; text-align: center; }
    #fleetSyncAddin .property-icon { margin-right: 0; margin-bottom: 12px; }
    #fleetSyncAddin footer { padding: 20px; }
}

/* Modal Styles */
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.modal-content { background-color: white; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); max-width: 90%; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease; }
@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
.modal-header { padding: 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
.modal-header h2 { margin: 0; font-size: 20px; font-weight: 700; color: #0f172a; }
.modal-close { background: none; border: none; font-size: 28px; color: #64748b; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s ease; }
.modal-close:hover { background-color: #f1f5f9; color: #0f172a; }
.modal-body { padding: 24px; }
.modal-body .property-item { display: block; margin-bottom: 16px; }
.modal-body label { display: block; font-weight: 600; margin-bottom: 6px; color: #0f172a; font-size: 13px; }
.modal-body input[type="checkbox"] { width: 18px; height: 18px; margin-right: 8px; cursor: pointer; }
.modal-footer { padding: 20px 24px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px; }
`;
            const style = document.createElement('style');
            style.textContent = css;
            document.head.appendChild(style);
        })();
    </script>
    <div id="fleetSyncAddin">
    <div class="container">
        <header>
            <div class="header-content">
                <h1>FleetSync Property Manager</h1>
                <p class="subtitle">Manage custom properties for FleetSync equipment mailbox automation</p>
            </div>
        </header>

        <nav class="tab-navigation">
            <button class="tab-button active" data-tab="properties">Property Setup</button>
            <button class="tab-button" data-tab="assets">Manage Assets</button>
            <button class="tab-button" data-tab="sync">Sync to Exchange</button>
        </nav>

        <div class="content-wrapper tab-content active" id="propertiesTab">
            <section class="status-section">
            <h2>Status</h2>
            <div id="statusMessage" class="status-message status-info">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                <span>Ready. Click "Check Properties" to scan for existing custom properties.</span>
            </div>
            <div id="propertyStatus" class="property-status"></div>
        </section>

        <section class="properties-section">
            <h2>Required Custom Properties</h2>
            <p class="info-text">
                These custom properties are required by the FleetSync orchestrator to manage Exchange equipment mailboxes.
                Click "Check Properties" to verify which properties exist, then "Create Missing Properties" to add any that are missing.
            </p>

            <div class="property-list">
                <!-- Booking Configuration -->
                <div class="property-item">
                    <div class="property-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 11l3 3L22 4"></path>
                            <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
                        </svg>
                    </div>
                    <div class="property-details">
                        <h3>Enable Equipment Booking</h3>
                        <p>Boolean (Toggle) - Allow this equipment to be booked through Outlook/Teams calendar</p>
                        <span class="property-status-badge" data-property="Bookable">Not checked</span>
                    </div>
                </div>

                <div class="property-item">
                    <div class="property-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <polyline points="1 20 1 14 7 14"></polyline>
                            <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"></path>
                        </svg>
                    </div>
                    <div class="property-details">
                        <h3>Allow Recurring Bookings</h3>
                        <p>Boolean (Toggle) - Permit users to create recurring/repeating bookings</p>
                        <span class="property-status-badge" data-property="AllowRecurringBooking">Not checked</span>
                    </div>
                </div>

                <div class="property-item">
                    <div class="property-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 00-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 010 7.75"></path>
                        </svg>
                    </div>
                    <div class="property-details">
                        <h3>Booking Approvers</h3>
                        <p>Text - Email addresses of people who must approve booking requests (semicolon-separated)</p>
                        <span class="property-status-badge" data-property="Approvers">Not checked</span>
                    </div>
                </div>

                <div class="property-item">
                    <div class="property-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="property-details">
                        <h3>Fleet Managers</h3>
                        <p>Text - Email addresses of fleet managers who need full calendar access (semicolon-separated)</p>
                        <span class="property-status-badge" data-property="FleetManagers">Not checked</span>
                    </div>
                </div>

                <div class="property-item">
                    <div class="property-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                        </svg>
                    </div>
                    <div class="property-details">
                        <h3>Allow Double Booking</h3>
                        <p>Boolean (Toggle) - Allow multiple bookings at the same time (normally disabled)</p>
                        <span class="property-status-badge" data-property="AllowConflicts">Not checked</span>
                    </div>
                </div>

                <div class="property-item">
                    <div class="property-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                    </div>
                    <div class="property-details">
                        <h3>Booking Window (Days)</h3>
                        <p>Number - How many days in advance users can book this equipment (e.g., 90)</p>
                        <span class="property-status-badge" data-property="BookingWindowInDays">Not checked</span>
                    </div>
                </div>

                <div class="property-item">
                    <div class="property-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                    </div>
                    <div class="property-details">
                        <h3>Maximum Booking Duration (Hours)</h3>
                        <p>Number - Maximum length of a single booking in hours (e.g., 8)</p>
                        <span class="property-status-badge" data-property="MaximumDurationInHours">Not checked</span>
                    </div>
                </div>

                <!-- Regional Settings -->
                <div class="property-item">
                    <div class="property-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M2 12h20"></path>
                            <path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"></path>
                        </svg>
                    </div>
                    <div class="property-details">
                        <h3>Mailbox Language</h3>
                        <p>Text - Language code for booking confirmation emails (e.g., en-AU, en-US)</p>
                        <span class="property-status-badge" data-property="MailboxLanguage">Not checked</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="actions-section">
            <button id="checkPropertiesBtn" class="btn btn-primary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="M21 21l-4.35-4.35"></path>
                </svg>
                Check Properties
            </button>
            <button id="createPropertiesBtn" class="btn btn-success" disabled>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Create Missing Properties
            </button>
            <button id="refreshBtn" class="btn btn-secondary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"></path>
                </svg>
                Refresh
            </button>
        </section>

        <section class="help-section">
            <h2>About FleetSync</h2>
            <p>
                FleetSync creates and configures Exchange equipment mailboxes for vehicles and trailers, 
                sourced from MyGeotab assets, using an Azure Automation runbook orchestrator so staff can 
                book cars and trailers in Outlook.
            </p>
            <p>
                These custom properties allow the FleetSync orchestrator to:
            </p>
            <ul>
                <li>Control booking availability and permissions</li>
                <li>Set resource location and identification details</li>
                <li>Configure approval workflows</li>
                <li>Manage recurring booking policies</li>
            </ul>
            <p class="help-link">
                For more information, visit the 
                <a href="https://github.com/Autotrace-au/AHC-AssetCreator" target="_blank">FleetSync repository</a>.
            </p>
        </section>
        </div>

        <!-- Assets Tab -->
        <div class="content-wrapper tab-content" id="assetsTab">
            <section class="status-section">
                <h2>Asset Management</h2>
                <div id="assetStatusMessage" class="status-message status-info">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    <span>Click "Load Assets" to fetch all devices from MyGeotab and manage their booking properties.</span>
                </div>
            </section>

            <section class="actions-section">
                <button id="loadAssetsBtn" class="btn btn-primary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"></path>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                    </svg>
                    Load Assets
                </button>
                <button id="createGroupBtn" class="btn btn-secondary" style="margin-left: 10px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"></path>
                        <line x1="12" y1="11" x2="12" y2="17"></line>
                        <line x1="9" y1="14" x2="15" y2="14"></line>
                    </svg>
                    Create Group
                </button>
                <button id="saveAllAssetsBtn" class="btn btn-success" disabled>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save All Changes
                </button>
            </section>

            <section class="properties-section">
                <h2>Assets</h2>
                <p class="info-text">
                    Edit booking properties for each asset below. Changes are saved individually or you can save all at once.
                </p>
                <div id="assetTableContainer" class="asset-table-container" style="display: none;">
                    <table class="asset-table">
                        <thead>
                            <tr>
                                <th title="Assign to Group">Group</th>
                                <th>Asset</th>
                                <th title="Enable Equipment Booking">Bookable</th>
                                <th title="Allow Recurring Bookings">Recurring</th>
                                <th title="Booking Approvers (email addresses)">Approvers</th>
                                <th title="Fleet Managers (email addresses)">Fleet Mgrs</th>
                                <th title="Allow Double Booking">Conflicts</th>
                                <th title="Booking Window in Days">Window</th>
                                <th title="Maximum Duration in Hours">Max Hrs</th>
                                <th title="Mailbox Language">Lang</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="assetTableBody">
                            <!-- Asset rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <div class="content-wrapper tab-content" id="syncTab">
            <section class="status-section">
                <h2>Sync to Exchange Online</h2>
                <div id="syncStatusMessage" class="status-message status-info">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    <span>Configure your Azure Automation webhook to enable synchronisation with Exchange Online.</span>
                </div>
            </section>

            <section class="properties-section">
                <h2>Azure Automation Configuration</h2>
                <p class="info-text">
                    Enter the webhook URL from your Azure Automation runbook. This webhook will be called to trigger the FleetSync Orchestrator script that synchronises MyGeotab devices with Exchange equipment mailboxes.
                </p>

                <div class="property-item">
                    <div class="property-info">
                        <div class="property-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                            </svg>
                        </div>
                        <div>
                            <h3>Webhook URL</h3>
                            <p>Azure Automation webhook endpoint for FleetSync Orchestrator</p>
                        </div>
                    </div>
                    <input type="text" id="webhookUrl" placeholder="https://your-webhook-url.azure-automation.net/webhooks?token=..." style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px; margin-top: 12px;">
                </div>

                <div style="margin-top: 20px;">
                    <button id="saveWebhookBtn" class="btn btn-primary">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                        Save Webhook URL
                    </button>
                </div>
            </section>

            <section class="properties-section">
                <h2>Manual Synchronisation</h2>
                <p class="info-text">
                    Trigger an immediate synchronisation between MyGeotab devices and Exchange equipment mailboxes. This will run the FleetSync Orchestrator script via the configured webhook.
                </p>

                <div style="margin-bottom: 16px; padding: 12px; background-color: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; font-size: 13px; color: #92400e;">
                    <strong>⚠️ CORS Limitation:</strong> Azure Automation webhooks don't support CORS, so direct browser calls will fail with "Failed to fetch".
                    The webhook request is still sent and may succeed, but you won't see a response. Check Azure Automation job history to verify execution.
                    <br><br>
                    <strong>Alternative:</strong> Use Azure Logic Apps or Azure Functions as a CORS-enabled proxy to call the webhook.
                </div>

                <div style="display: flex; gap: 12px; align-items: center;">
                    <button id="triggerSyncBtn" class="btn btn-success" disabled>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <polyline points="1 20 1 14 7 14"></polyline>
                            <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"></path>
                        </svg>
                        Trigger Sync Now
                    </button>
                    <span id="syncProgress" style="display: none; color: var(--text-muted); font-size: 13px;">
                        <span class="loading-spinner"></span> Synchronising...
                    </span>
                </div>

                <div id="syncResultContainer" style="display: none; margin-top: 20px; padding: 16px; background-color: var(--light-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                    <h4 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600;">Sync Result</h4>
                    <pre id="syncResult" style="margin: 0; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; color: var(--text-color);"></pre>
                </div>
            </section>
        </div>

        <footer>
            <div class="footer-content">
                <p>&copy; 2025 Autotrace. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Create Asset Group</h2>
                <button class="modal-close" onclick="document.getElementById('createGroupModal').style.display='none'">&times;</button>
            </div>
            <div class="modal-body">
                <p class="info-text" style="margin-bottom: 20px;">
                    Create a group with default booking properties. When you assign assets to this group, they will inherit these properties.
                </p>

                <div class="property-item">
                    <label for="groupName">Group Name</label>
                    <input type="text" id="groupName" placeholder="e.g., Company Vehicles, Heavy Equipment, Motorcycles" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px;">
                </div>

                <h3 style="margin: 24px 0 12px 0; font-size: 16px; font-weight: 600;">Default Booking Properties</h3>

                <div class="property-item">
                    <label><input type="checkbox" id="groupBookable"> Enable Equipment Booking</label>
                </div>

                <div class="property-item">
                    <label><input type="checkbox" id="groupRecurring"> Allow Recurring Bookings</label>
                </div>

                <div class="property-item">
                    <label for="groupApprovers">Booking Approvers (email addresses, semicolon-separated)</label>
                    <input type="text" id="groupApprovers" placeholder="manager@company.com.au;supervisor@company.com.au" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px;">
                </div>

                <div class="property-item">
                    <label for="groupFleetManagers">Fleet Managers (email addresses, semicolon-separated)</label>
                    <input type="text" id="groupFleetManagers" placeholder="fleet@company.com.au" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px;">
                </div>

                <div class="property-item">
                    <label><input type="checkbox" id="groupConflicts"> Allow Double Booking</label>
                </div>

                <div class="property-item">
                    <label for="groupWindowDays">Booking Window (Days)</label>
                    <input type="number" id="groupWindowDays" value="90" min="1" max="365" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px;">
                </div>

                <div class="property-item">
                    <label for="groupMaxDurationHours">Maximum Booking Duration (Hours)</label>
                    <input type="number" id="groupMaxDurationHours" value="24" min="1" max="720" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px;">
                </div>

                <div class="property-item">
                    <label for="groupLanguage">Mailbox Language</label>
                    <input type="text" id="groupLanguage" value="en-AU" placeholder="en-AU" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="document.getElementById('createGroupModal').style.display='none'">Cancel</button>
                <button id="saveGroupBtn" class="btn btn-primary">Create Group</button>
            </div>
        </div>
    </div>

    <!-- Assign Group Modal -->
    <div id="assignGroupModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Assign to Group</h2>
                <button class="modal-close" onclick="document.getElementById('assignGroupModal').style.display='none'">&times;</button>
            </div>
            <div class="modal-body">
                <p class="info-text" style="margin-bottom: 20px;">
                    <strong id="assignAssetName"></strong>
                </p>
                <p class="info-text" style="margin-bottom: 20px; color: var(--warning-color); font-weight: 600;">
                    Warning: Assigning to a group will overwrite all current booking properties with the group's default values.
                </p>

                <div class="property-item">
                    <label for="selectGroup">Select Group</label>
                    <select id="selectGroup" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px;">
                        <option value="">-- Select a group --</option>
                    </select>
                </div>

                <div id="noGroupsMessage" style="display: none; padding: 16px; background-color: var(--light-bg); border-radius: 8px; margin-top: 12px;">
                    <p style="margin: 0; color: var(--text-muted);">No groups available. Create a group first using the "Create Group" button.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="document.getElementById('assignGroupModal').style.display='none'">Cancel</button>
                <button id="confirmAssignGroupBtn" class="btn btn-primary">Assign to Group</button>
            </div>
        </div>
    </div>

    <!-- Edit Group Modal -->
    <div id="editGroupModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Edit Group</h2>
                <button class="modal-close" onclick="document.getElementById('editGroupModal').style.display='none'">&times;</button>
            </div>
            <div class="modal-body">
                <p class="info-text" style="margin-bottom: 20px; color: var(--warning-color); font-weight: 600;">
                    Warning: Changing group properties will update ALL assets assigned to this group.
                </p>

                <div class="property-item">
                    <label for="editGroupName">Group Name</label>
                    <input type="text" id="editGroupName" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px;">
                </div>

                <h3 style="margin: 24px 0 12px 0; font-size: 16px; font-weight: 600;">Default Booking Properties</h3>

                <div class="property-item">
                    <label><input type="checkbox" id="editGroupBookable"> Enable Equipment Booking</label>
                </div>

                <div class="property-item">
                    <label><input type="checkbox" id="editGroupRecurring"> Allow Recurring Bookings</label>
                </div>

                <div class="property-item">
                    <label for="editGroupApprovers">Booking Approvers (email addresses, semicolon-separated)</label>
                    <input type="text" id="editGroupApprovers" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px;">
                </div>

                <div class="property-item">
                    <label for="editGroupFleetManagers">Fleet Managers (email addresses, semicolon-separated)</label>
                    <input type="text" id="editGroupFleetManagers" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px;">
                </div>

                <div class="property-item">
                    <label><input type="checkbox" id="editGroupConflicts"> Allow Double Booking</label>
                </div>

                <div class="property-item">
                    <label for="editGroupWindowDays">Booking Window (Days)</label>
                    <input type="number" id="editGroupWindowDays" min="1" max="365" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px;">
                </div>

                <div class="property-item">
                    <label for="editGroupMaxDurationHours">Maximum Booking Duration (Hours)</label>
                    <input type="number" id="editGroupMaxDurationHours" min="1" max="720" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px;">
                </div>

                <div class="property-item">
                    <label for="editGroupLanguage">Mailbox Language</label>
                    <input type="text" id="editGroupLanguage" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="document.getElementById('editGroupModal').style.display='none'">Cancel</button>
                <button id="saveEditGroupBtn" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>
    </div>

    <script>
        /**
         * FleetSync Property Manager Add-In
         */
        (function() {
            // Ensure geotab object exists
            if (typeof geotab === 'undefined') {
                window.geotab = {};
            }
            if (typeof geotab.addin === 'undefined') {
                geotab.addin = {};
            }

            geotab.addin.fleetSyncPropertyManager = () => {
            let api;
            let state;

            const REQUIRED_PROPERTIES = [
                // Booking Configuration
                { name: 'Enable Equipment Booking', internalName: 'Bookable', description: 'Allow this equipment to be booked through Outlook/Teams calendar. When enabled, an Exchange mailbox will be created and configured for booking. Default: false (not bookable)', dataType: 'Boolean' },
                { name: 'Allow Recurring Bookings', internalName: 'AllowRecurringBooking', description: 'Permit users to create recurring/repeating bookings for this equipment (e.g., weekly bookings). Default: false (no recurring)', dataType: 'Boolean' },
                { name: 'Booking Approvers', internalName: 'Approvers', description: 'Email addresses of people who must approve booking requests (semicolon-separated). Default: blank (auto-accept, no approval required). Example: manager@company.com.au;supervisor@company.com.au', dataType: 'String' },
                { name: 'Fleet Managers', internalName: 'FleetManagers', description: 'Email addresses of fleet managers who need full calendar access to view and manage all bookings (semicolon-separated). Default: blank (no fleet managers). Example: fleet@company.com.au', dataType: 'String' },
                { name: 'Allow Double Booking', internalName: 'AllowConflicts', description: 'Allow multiple bookings at the same time (double-booking). Normally disabled to prevent scheduling conflicts. Default: false (no conflicts)', dataType: 'Boolean' },
                { name: 'Booking Window (Days)', internalName: 'BookingWindowInDays', description: 'How many days in advance users can book this equipment. Default: 90 days. Example: 90 means users can book up to 90 days ahead.', dataType: 'Integer' },
                { name: 'Maximum Booking Duration (Hours)', internalName: 'MaximumDurationInHours', description: 'Maximum length of a single booking in hours. Default: 24 hours. Example: 24 means bookings cannot exceed 24 hours (1 day).', dataType: 'Integer' },

                // Regional Settings
                { name: 'Mailbox Language', internalName: 'MailboxLanguage', description: 'Language code for booking confirmation emails. Default: en-AU (Australian English). Other examples: en-US, en-GB.', dataType: 'String' }
            ];

            let existingProperties = [];
            let missingProperties = [];

            function initialize(apiInstance, stateInstance, callback) {
                api = apiInstance;
                state = stateInstance;

                // Load groups from localStorage
                loadGroups();

                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', setupEventListeners);
                } else {
                    setupEventListeners();
                }

                // Load saved webhook URL
                loadWebhookUrl();

                callback();
            }

            function focus(apiInstance, stateInstance) {
                api = apiInstance;
                state = stateInstance;
                updateStatus('Ready. Click "Check Properties" to scan for existing custom properties.', 'info');
            }

            function blur(apiInstance, stateInstance) {}

            function setupEventListeners() {
                const checkBtn = document.getElementById('checkPropertiesBtn');
                const createBtn = document.getElementById('createPropertiesBtn');
                const refreshBtn = document.getElementById('refreshBtn');
                const loadAssetsBtn = document.getElementById('loadAssetsBtn');
                const createGroupBtn = document.getElementById('createGroupBtn');
                const saveGroupBtn = document.getElementById('saveGroupBtn');
                const saveEditGroupBtn = document.getElementById('saveEditGroupBtn');
                const confirmAssignGroupBtn = document.getElementById('confirmAssignGroupBtn');
                const saveAllAssetsBtn = document.getElementById('saveAllAssetsBtn');
                const saveWebhookBtn = document.getElementById('saveWebhookBtn');
                const triggerSyncBtn = document.getElementById('triggerSyncBtn');

                if (checkBtn) checkBtn.addEventListener('click', checkProperties);
                if (createBtn) createBtn.addEventListener('click', createMissingProperties);
                if (refreshBtn) refreshBtn.addEventListener('click', refreshPage);
                if (loadAssetsBtn) loadAssetsBtn.addEventListener('click', loadAssets);
                if (createGroupBtn) createGroupBtn.addEventListener('click', openCreateGroupModal);
                if (saveGroupBtn) saveGroupBtn.addEventListener('click', saveNewGroup);
                if (saveEditGroupBtn) saveEditGroupBtn.addEventListener('click', saveEditGroup);
                if (confirmAssignGroupBtn) confirmAssignGroupBtn.addEventListener('click', assignAssetToGroup);
                if (saveAllAssetsBtn) saveAllAssetsBtn.addEventListener('click', saveAllAssets);
                if (saveWebhookBtn) saveWebhookBtn.addEventListener('click', saveWebhookUrl);
                if (triggerSyncBtn) triggerSyncBtn.addEventListener('click', triggerSync);

                // Tab switching
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', () => switchTab(button.dataset.tab));
                });

                // Load saved webhook URL on init
                loadWebhookUrl();
            }

            function switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabName);
                });

                // Update tab content
                document.getElementById('propertiesTab').classList.toggle('active', tabName === 'properties');
                document.getElementById('assetsTab').classList.toggle('active', tabName === 'assets');
                document.getElementById('syncTab').classList.toggle('active', tabName === 'sync');
            }

            function getStatusIcon(type) {
                const icons = {
                    info: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>',
                    success: '<svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
                    warning: '<svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
                    error: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>'
                };
                return icons[type] || icons.info;
            }

            function updateStatus(message, type = 'info') {
                const statusElement = document.getElementById('statusMessage');
                if (statusElement) {
                    statusElement.innerHTML = getStatusIcon(type) + '<span>' + message + '</span>';
                    statusElement.className = `status-message status-${type}`;
                }
            }

            function updatePropertyBadges() {
                REQUIRED_PROPERTIES.forEach(prop => {
                    const badge = document.querySelector(`[data-property="${prop.internalName}"]`);
                    if (badge) {
                        const exists = existingProperties.some(ep => ep.name.toLowerCase() === prop.name.toLowerCase());
                        if (exists) {
                            badge.textContent = 'Exists';
                            badge.className = 'property-status-badge status-exists';
                        } else {
                            badge.textContent = 'Missing';
                            badge.className = 'property-status-badge status-missing';
                        }
                    }
                });
            }

            async function checkProperties() {
                updateStatus('Checking existing custom properties...', 'info');
                const checkBtn = document.getElementById('checkPropertiesBtn');
                const createBtn = document.getElementById('createPropertiesBtn');
                if (checkBtn) checkBtn.disabled = true;

                try {
                    const properties = await new Promise((resolve, reject) => {
                        api.call('Get', { typeName: 'Property', search: {} }, resolve, reject);
                    });

                    existingProperties = properties || [];

                    // Log a sample property to see its structure
                    if (existingProperties.length > 0) {
                        console.log('Sample existing property structure:', JSON.stringify(existingProperties[0], null, 2));
                    }

                    missingProperties = REQUIRED_PROPERTIES.filter(reqProp => {
                        return !existingProperties.some(existProp => existProp.name.toLowerCase() === reqProp.name.toLowerCase());
                    });

                    updatePropertyBadges();

                    if (missingProperties.length === 0) {
                        updateStatus('All required properties exist!', 'success');
                        if (createBtn) createBtn.disabled = true;
                    } else {
                        updateStatus(`Found ${existingProperties.length} properties. ${missingProperties.length} required properties are missing.`, 'warning');
                        if (createBtn) createBtn.disabled = false;
                    }
                } catch (error) {
                    console.error('Error checking properties:', error);
                    updateStatus(`Error: ${error.message || 'Failed to check properties'}`, 'error');
                } finally {
                    if (checkBtn) checkBtn.disabled = false;
                }
            }

            async function createMissingProperties() {
                if (missingProperties.length === 0) {
                    updateStatus('No missing properties to create.', 'info');
                    return;
                }

                updateStatus('Creating FleetSync PropertySet...', 'info');
                const createBtn = document.getElementById('createPropertiesBtn');
                if (createBtn) createBtn.disabled = true;

                let successCount = 0;
                let errorCount = 0;

                try {
                    // First, check if FleetSync PropertySet exists
                    let propertySet;
                    try {
                        const propertySets = await new Promise((resolve, reject) => {
                            api.call('Get', {
                                typeName: 'PropertySet',
                                search: { name: 'FleetSync Properties' }
                            }, resolve, reject);
                        });

                        if (propertySets && propertySets.length > 0) {
                            propertySet = propertySets[0];
                            console.log('Found existing FleetSync PropertySet:', propertySet);
                        }
                    } catch (error) {
                        console.log('PropertySet not found, will create new one');
                    }

                    // Create PropertySet if it doesn't exist
                    if (!propertySet) {
                        updateStatus('Creating FleetSync PropertySet...', 'info');
                        try {
                            const propertySetEntity = {
                                name: 'FleetSync Properties',
                                description: 'Custom properties for FleetSync equipment mailbox automation'
                            };

                            propertySet = await new Promise((resolve, reject) => {
                                api.call('Add', {
                                    typeName: 'PropertySet',
                                    entity: propertySetEntity
                                }, resolve, reject);
                            });

                            console.log('Created PropertySet:', propertySet);
                        } catch (error) {
                            console.error('Failed to create PropertySet:', error);
                            updateStatus(`Error: Failed to create PropertySet - ${error.message || error}`, 'error');
                            if (createBtn) createBtn.disabled = false;
                            return;
                        }
                    }

                    // Now create the properties with the PropertySet
                    updateStatus(`Creating ${missingProperties.length} missing properties...`, 'info');

                    // PropertySet ID might be returned as a string or an object with id property
                    const propertySetId = typeof propertySet === 'string' ? propertySet : propertySet.id;
                    console.log('Using PropertySet ID:', propertySetId);

                    for (const prop of missingProperties) {
                        try {
                            // MyGeotab Property entity structure
                            const propertyEntity = {
                                name: prop.name,
                                description: prop.description,
                                propertySet: { id: propertySetId },
                                entityTypes: ['Device'],
                                propertyType: prop.dataType  // Use dataType directly: 'Boolean', 'Number', or 'String'
                            };

                            console.log('Creating property:', prop.name, 'with propertyType:', prop.dataType);
                            console.log('Property entity:', JSON.stringify(propertyEntity, null, 2));

                            await new Promise((resolve, reject) => {
                                api.call('Add', { typeName: 'Property', entity: propertyEntity }, resolve, reject);
                            });

                            successCount++;
                            console.log(`Created property: ${prop.name}`);
                        } catch (error) {
                            errorCount++;
                            console.error(`Failed to create property ${prop.name}:`, error);
                        }
                    }

                    if (errorCount === 0) {
                        updateStatus(`Successfully created ${successCount} properties!`, 'success');
                    } else {
                        updateStatus(`Created ${successCount} properties with ${errorCount} errors. Check console for details.`, 'warning');
                    }

                    setTimeout(() => checkProperties(), 1000);
                } catch (error) {
                    console.error('Error creating properties:', error);
                    updateStatus(`Error: ${error.message || 'Failed to create properties'}`, 'error');
                }
            }

            function refreshPage() {
                existingProperties = [];
                missingProperties = [];
                const badges = document.querySelectorAll('.property-status-badge');
                badges.forEach(badge => {
                    badge.textContent = 'Not checked';
                    badge.className = 'property-status-badge';
                });
                updateStatus('Ready. Click "Check Properties" to scan for existing custom properties.', 'info');
                const createBtn = document.getElementById('createPropertiesBtn');
                if (createBtn) createBtn.disabled = true;
            }

            // Asset Management Functions
            let allAssets = [];
            let assetChanges = {};
            let assetGroups = [];

            // Load groups from localStorage
            function loadGroups() {
                const stored = localStorage.getItem('fleetSyncGroups');
                if (stored) {
                    try {
                        assetGroups = JSON.parse(stored);
                    } catch (e) {
                        console.error('Failed to load groups:', e);
                        assetGroups = [];
                    }
                }
                return assetGroups;
            }

            // Save groups to localStorage
            function saveGroups() {
                localStorage.setItem('fleetSyncGroups', JSON.stringify(assetGroups));
            }

            // Create new group
            function createGroup(name, properties) {
                const group = {
                    id: 'group_' + Date.now(),
                    name: name,
                    properties: properties,
                    createdAt: new Date().toISOString()
                };
                assetGroups.push(group);
                saveGroups();
                return group;
            }

            // Open create group modal
            function openCreateGroupModal() {
                console.log('openCreateGroupModal called');
                const modal = document.getElementById('createGroupModal');
                if (!modal) {
                    console.error('createGroupModal not found');
                    return;
                }

                console.log('Modal found, resetting form');
                // Reset form
                document.getElementById('groupName').value = '';
                document.getElementById('groupBookable').checked = false;
                document.getElementById('groupRecurring').checked = false;
                document.getElementById('groupApprovers').value = '';
                document.getElementById('groupFleetManagers').value = '';
                document.getElementById('groupConflicts').checked = false;
                document.getElementById('groupWindowDays').value = '90';
                document.getElementById('groupMaxDurationHours').value = '24';
                document.getElementById('groupLanguage').value = 'en-AU';

                modal.style.display = 'flex';
                console.log('Modal displayed');
            }

            // Save new group
            function saveNewGroup() {
                const name = document.getElementById('groupName').value.trim();

                if (!name) {
                    alert('Please enter a group name');
                    return;
                }

                const properties = {
                    bookable: document.getElementById('groupBookable').checked,
                    recurring: document.getElementById('groupRecurring').checked,
                    approvers: document.getElementById('groupApprovers').value.trim(),
                    fleetManagers: document.getElementById('groupFleetManagers').value.trim(),
                    conflicts: document.getElementById('groupConflicts').checked,
                    windowDays: parseInt(document.getElementById('groupWindowDays').value) || 90,
                    maxDurationHours: parseInt(document.getElementById('groupMaxDurationHours').value) || 24,
                    language: document.getElementById('groupLanguage').value.trim() || 'en-AU'
                };

                const group = createGroup(name, properties);

                // Close modal
                document.getElementById('createGroupModal').style.display = 'none';

                // Show success message
                updateAssetStatus(`Group "${name}" created successfully! Assign assets to this group to apply these properties.`, 'success');

                console.log('Created group:', group);
            }

            // Edit group
            let currentEditGroupId = null;

            function editGroup(groupId) {
                currentEditGroupId = groupId;
                const group = assetGroups.find(g => g.id === groupId);
                if (!group) return;

                const modal = document.getElementById('editGroupModal');

                // Populate form with current values
                document.getElementById('editGroupName').value = group.name;
                document.getElementById('editGroupBookable').checked = group.properties.bookable;
                document.getElementById('editGroupRecurring').checked = group.properties.recurring;
                document.getElementById('editGroupApprovers').value = group.properties.approvers;
                document.getElementById('editGroupFleetManagers').value = group.properties.fleetManagers;
                document.getElementById('editGroupConflicts').checked = group.properties.conflicts;
                document.getElementById('editGroupWindowDays').value = group.properties.windowDays;
                document.getElementById('editGroupMaxDurationHours').value = group.properties.maxDurationHours;
                document.getElementById('editGroupLanguage').value = group.properties.language;

                modal.style.display = 'flex';
            }

            async function saveEditGroup() {
                const groupId = currentEditGroupId;
                const group = assetGroups.find(g => g.id === groupId);
                if (!group) return;

                const name = document.getElementById('editGroupName').value.trim();

                if (!name) {
                    alert('Please enter a group name');
                    return;
                }

                const properties = {
                    bookable: document.getElementById('editGroupBookable').checked,
                    recurring: document.getElementById('editGroupRecurring').checked,
                    approvers: document.getElementById('editGroupApprovers').value.trim(),
                    fleetManagers: document.getElementById('editGroupFleetManagers').value.trim(),
                    conflicts: document.getElementById('editGroupConflicts').checked,
                    windowDays: parseInt(document.getElementById('editGroupWindowDays').value) || 90,
                    maxDurationHours: parseInt(document.getElementById('editGroupMaxDurationHours').value) || 24,
                    language: document.getElementById('editGroupLanguage').value.trim() || 'en-AU'
                };

                // Update group
                group.name = name;
                group.properties = properties;
                saveGroups();

                // Update all assets in this group
                const assetsInGroup = allAssets.filter(a => a.groupId === groupId);

                if (assetsInGroup.length > 0) {
                    try {
                        updateAssetStatus(`Updating ${assetsInGroup.length} assets in group "${name}"...`, 'info');

                        for (const asset of assetsInGroup) {
                            await updateDeviceProperties(asset.id, properties);
                            asset.properties = { ...properties };
                        }

                        updateAssetStatus(`Updated group "${name}" and ${assetsInGroup.length} assets successfully.`, 'success');
                    } catch (error) {
                        console.error('Error updating assets:', error);
                        updateAssetStatus(`Error updating assets: ${error.message}`, 'error');
                    }
                }

                // Close modal and refresh table
                document.getElementById('editGroupModal').style.display = 'none';
                renderAssetTable();
            }

            function deleteGroup(groupId) {
                const group = assetGroups.find(g => g.id === groupId);
                if (!group) return;

                const assetsInGroup = allAssets.filter(a => a.groupId === groupId);
                const assetCount = assetsInGroup.length;

                const confirmMsg = assetCount > 0
                    ? `Are you sure you want to delete the group "${group.name}"?\n\n${assetCount} asset${assetCount !== 1 ? 's' : ''} will be unassigned from this group (their properties will remain unchanged).`
                    : `Are you sure you want to delete the group "${group.name}"?`;

                if (!confirm(confirmMsg)) return;

                // Remove group from array
                const index = assetGroups.findIndex(g => g.id === groupId);
                if (index !== -1) {
                    assetGroups.splice(index, 1);
                    saveGroups();
                }

                // Unassign all assets from this group
                assetsInGroup.forEach(asset => {
                    delete asset.groupId;
                });

                // Refresh table
                renderAssetTable();
                updateAssetStatus(`Deleted group "${group.name}" and unassigned ${assetCount} asset${assetCount !== 1 ? 's' : ''}.`, 'success');
            }

            // Show group assignment modal
            let currentAssignAssetIndex = null;

            function showGroupAssignmentModal(assetIndex) {
                currentAssignAssetIndex = assetIndex;
                const asset = allAssets[assetIndex];
                const modal = document.getElementById('assignGroupModal');
                const assetNameEl = document.getElementById('assignAssetName');
                const selectGroup = document.getElementById('selectGroup');
                const noGroupsMsg = document.getElementById('noGroupsMessage');
                const confirmBtn = document.getElementById('confirmAssignGroupBtn');

                if (!modal || !asset) return;

                // Set asset name
                assetNameEl.textContent = `Assign "${asset.name}" to a group`;

                // Populate group dropdown
                selectGroup.innerHTML = '<option value="">-- Select a group --</option>';

                if (assetGroups.length === 0) {
                    noGroupsMsg.style.display = 'block';
                    selectGroup.style.display = 'none';
                    confirmBtn.disabled = true;
                } else {
                    noGroupsMsg.style.display = 'none';
                    selectGroup.style.display = 'block';
                    confirmBtn.disabled = false;

                    assetGroups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group.id;
                        option.textContent = group.name;
                        selectGroup.appendChild(option);
                    });
                }

                modal.style.display = 'flex';
            }

            // Assign asset to group
            async function assignAssetToGroup() {
                console.log('assignAssetToGroup called');
                const selectGroup = document.getElementById('selectGroup');
                const groupId = selectGroup.value;

                if (!groupId) {
                    alert('Please select a group');
                    return;
                }

                const group = assetGroups.find(g => g.id === groupId);
                if (!group) {
                    alert('Group not found');
                    return;
                }

                const asset = allAssets[currentAssignAssetIndex];
                if (!asset) {
                    console.error('Asset not found at index:', currentAssignAssetIndex);
                    return;
                }

                console.log('Assigning asset to group:', asset.name, 'Group:', group.name);
                console.log('Group properties:', group.properties);

                try {
                    // Copy group properties to asset
                    const updates = { ...group.properties };
                    console.log('Updates to apply:', updates);

                    // Update properties in MyGeotab
                    updateAssetStatus(`Updating "${asset.name}" with group properties...`, 'info');
                    await updateDeviceProperties(asset.id, updates);
                    console.log('Device properties updated successfully');

                    // Update local data
                    asset.properties = updates;
                    asset.groupId = groupId;

                    // Close modal
                    document.getElementById('assignGroupModal').style.display = 'none';

                    // Refresh table
                    renderAssetTable();

                    // Show success message
                    updateAssetStatus(`Assigned "${asset.name}" to group "${group.name}" and applied group properties.`, 'success');

                } catch (error) {
                    console.error('Error assigning asset to group:', error);
                    updateAssetStatus(`Error assigning asset to group: ${error.message}`, 'error');
                    alert(`Error: ${error.message}`);
                }
            }

            function updateAssetStatus(message, type = 'info') {
                const statusElement = document.getElementById('assetStatusMessage');
                if (statusElement) {
                    statusElement.innerHTML = getStatusIcon(type) + '<span>' + message + '</span>';
                    statusElement.className = `status-message status-${type}`;
                }
            }

            async function loadAssets() {
                const loadBtn = document.getElementById('loadAssetsBtn');
                const saveAllBtn = document.getElementById('saveAllAssetsBtn');
                const tableContainer = document.getElementById('assetTableContainer');

                try {
                    loadBtn.disabled = true;
                    loadBtn.innerHTML = '<span class="loading-spinner"></span> Loading...';
                    updateAssetStatus('Loading assets from MyGeotab...', 'info');

                    // Get all devices with their custom properties
                    const devices = await new Promise((resolve, reject) => {
                        api.call('Get', {
                            typeName: 'Device',
                            resultsLimit: 5000
                        }, resolve, reject);
                    });

                    allAssets = devices.map(device => {
                        return {
                            id: device.id,
                            name: device.name,
                            serialNumber: device.serialNumber,
                            device: device,  // Store full device object
                            properties: getDeviceProperties(device)
                        };
                    });

                    renderAssetTable();
                    tableContainer.style.display = 'block';
                    saveAllBtn.disabled = false;
                    updateAssetStatus(`Loaded ${allAssets.length} assets successfully.`, 'success');

                } catch (error) {
                    console.error('Error loading assets:', error);
                    updateAssetStatus(`Error: ${error.message || 'Failed to load assets'}`, 'error');
                } finally {
                    loadBtn.disabled = false;
                    loadBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg> Load Assets';
                }
            }

            function getDeviceProperties(device) {
                const props = {
                    bookable: false,
                    recurring: false,
                    approvers: '',
                    fleetManagers: '',
                    conflicts: false,
                    windowDays: 90,
                    maxDurationHours: 24,
                    language: 'en-AU'
                };

                // Custom properties are stored directly on the device object
                // Look for properties by their internal names
                if (device.bookable !== undefined) props.bookable = device.bookable === true || device.bookable === 'true';
                if (device.Bookable !== undefined) props.bookable = device.Bookable === true || device.Bookable === 'true';

                if (device.allowRecurringBooking !== undefined) props.recurring = device.allowRecurringBooking === true || device.allowRecurringBooking === 'true';
                if (device.AllowRecurringBooking !== undefined) props.recurring = device.AllowRecurringBooking === true || device.AllowRecurringBooking === 'true';

                if (device.approvers !== undefined) props.approvers = device.approvers || '';
                if (device.Approvers !== undefined) props.approvers = device.Approvers || '';

                if (device.fleetManagers !== undefined) props.fleetManagers = device.fleetManagers || '';
                if (device.FleetManagers !== undefined) props.fleetManagers = device.FleetManagers || '';

                if (device.allowConflicts !== undefined) props.conflicts = device.allowConflicts === true || device.allowConflicts === 'true';
                if (device.AllowConflicts !== undefined) props.conflicts = device.AllowConflicts === true || device.AllowConflicts === 'true';

                if (device.bookingWindowInDays !== undefined) props.windowDays = parseInt(device.bookingWindowInDays) || 90;
                if (device.BookingWindowInDays !== undefined) props.windowDays = parseInt(device.BookingWindowInDays) || 90;

                if (device.maximumDurationInHours !== undefined) props.maxDurationHours = parseInt(device.maximumDurationInHours) || 24;
                if (device.MaximumDurationInHours !== undefined) props.maxDurationHours = parseInt(device.MaximumDurationInHours) || 24;

                if (device.mailboxLanguage !== undefined) props.language = device.mailboxLanguage || 'en-AU';
                if (device.MailboxLanguage !== undefined) props.language = device.MailboxLanguage || 'en-AU';

                return props;
            }

            function renderAssetTable() {
                console.log('renderAssetTable called, assets:', allAssets.length, 'groups:', assetGroups.length);
                const tbody = document.getElementById('assetTableBody');
                if (!tbody) {
                    console.error('assetTableBody not found');
                    return;
                }
                tbody.innerHTML = '';

                // Group assets by their groupId
                const groupedAssets = {};
                const ungroupedAssets = [];

                allAssets.forEach((asset, index) => {
                    asset.originalIndex = index; // Store original index for reference
                    if (asset.groupId) {
                        if (!groupedAssets[asset.groupId]) {
                            groupedAssets[asset.groupId] = [];
                        }
                        groupedAssets[asset.groupId].push(asset);
                    } else {
                        ungroupedAssets.push(asset);
                    }
                });

                console.log('Grouped assets:', Object.keys(groupedAssets).length, 'Ungrouped:', ungroupedAssets.length);

                // Render groups first
                Object.keys(groupedAssets).forEach(groupId => {
                    const group = assetGroups.find(g => g.id === groupId);
                    if (!group) return;

                    const assets = groupedAssets[groupId];

                    // Create group header row
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'group-header-row';
                    headerRow.dataset.groupId = groupId;
                    headerRow.innerHTML = `
                        <td colspan="11">
                            <div class="group-header-wrapper">
                                <div class="group-header-content" data-toggle-group="${groupId}">
                                    <svg class="group-header-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"></path>
                                    </svg>
                                    <span>${escapeHtml(group.name)} (${assets.length} asset${assets.length !== 1 ? 's' : ''})</span>
                                </div>
                                <div class="group-header-actions">
                                    <button class="group-action-btn edit-btn" data-edit-group="${groupId}" title="Edit group">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                        Edit
                                    </button>
                                    <button class="group-action-btn delete-btn" data-delete-group="${groupId}" title="Delete group">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                                        </svg>
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(headerRow);

                    // Add click listener to toggle collapse
                    const toggleBtn = headerRow.querySelector('[data-toggle-group]');
                    if (toggleBtn) {
                        toggleBtn.addEventListener('click', () => toggleGroupCollapse(groupId));
                    }

                    // Add edit button listener
                    const editBtn = headerRow.querySelector('[data-edit-group]');
                    if (editBtn) {
                        editBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            editGroup(groupId);
                        });
                    }

                    // Add delete button listener
                    const deleteBtn = headerRow.querySelector('[data-delete-group]');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteGroup(groupId);
                        });
                    }

                    // Render assets in this group
                    assets.forEach(asset => {
                        const row = createAssetRow(asset);
                        row.classList.add('group-asset-row');
                        row.dataset.groupId = groupId;
                        tbody.appendChild(row);
                    });
                });

                // Render ungrouped assets
                if (ungroupedAssets.length > 0) {
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'group-header-row';
                    headerRow.dataset.groupId = 'ungrouped';
                    headerRow.innerHTML = `
                        <td colspan="11">
                            <div class="group-header-content">
                                <svg class="group-header-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                                <span>Ungrouped Assets (${ungroupedAssets.length} asset${ungroupedAssets.length !== 1 ? 's' : ''})</span>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(headerRow);

                    headerRow.addEventListener('click', () => toggleGroupCollapse('ungrouped'));

                    ungroupedAssets.forEach(asset => {
                        const row = createAssetRow(asset);
                        row.classList.add('group-asset-row');
                        row.dataset.groupId = 'ungrouped';
                        tbody.appendChild(row);
                    });
                }
            }

            function createAssetRow(asset) {
                const index = asset.originalIndex;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <button class="group-assign-btn" data-assign-group="${index}" title="Assign to group">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"></path>
                            </svg>
                        </button>
                    </td>
                    <td>
                        <div class="asset-name">${escapeHtml(asset.name)}</div>
                        <div class="asset-serial">${escapeHtml(asset.serialNumber)}</div>
                    </td>
                    <td><input type="checkbox" data-asset="${index}" data-prop="bookable" ${asset.properties.bookable ? 'checked' : ''}></td>
                    <td><input type="checkbox" data-asset="${index}" data-prop="recurring" ${asset.properties.recurring ? 'checked' : ''}></td>
                    <td><input type="text" data-asset="${index}" data-prop="approvers" value="${escapeHtml(asset.properties.approvers)}" placeholder="email1;email2"></td>
                    <td><input type="text" data-asset="${index}" data-prop="fleetManagers" value="${escapeHtml(asset.properties.fleetManagers)}" placeholder="email1;email2"></td>
                    <td><input type="checkbox" data-asset="${index}" data-prop="conflicts" ${asset.properties.conflicts ? 'checked' : ''}></td>
                    <td><input type="number" data-asset="${index}" data-prop="windowDays" value="${asset.properties.windowDays}" min="1" max="365"></td>
                    <td><input type="number" data-asset="${index}" data-prop="maxDurationHours" value="${asset.properties.maxDurationHours}" min="1" max="720"></td>
                    <td><input type="text" data-asset="${index}" data-prop="language" value="${escapeHtml(asset.properties.language)}" placeholder="en-AU"></td>
                    <td class="save-btn-cell">
                        <button class="btn btn-primary btn-save" data-save-asset="${index}">Save</button>
                    </td>
                `;

                // Add change listeners
                row.querySelectorAll('input').forEach(input => {
                    input.addEventListener('change', () => trackAssetChange(index));
                });

                // Add save button listener
                const saveBtn = row.querySelector('[data-save-asset]');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => saveAsset(index));
                }

                // Add group assignment button listener
                const groupBtn = row.querySelector('[data-assign-group]');
                if (groupBtn) {
                    groupBtn.addEventListener('click', () => showGroupAssignmentModal(index));
                }

                return row;
            }

            function toggleGroupCollapse(groupId) {
                const rows = document.querySelectorAll(`[data-group-id="${groupId}"].group-asset-row`);
                const headerRow = document.querySelector(`[data-group-id="${groupId}"].group-header-row`);
                const icon = headerRow ? headerRow.querySelector('.group-header-icon') : null;

                rows.forEach(row => {
                    row.classList.toggle('hidden');
                });

                if (icon) {
                    icon.classList.toggle('collapsed');
                }
            }

            function trackAssetChange(assetIndex) {
                assetChanges[assetIndex] = true;
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text || '';
                return div.innerHTML;
            }

            async function saveAsset(assetIndex) {
                const asset = allAssets[assetIndex];
                if (!asset) return;

                try {
                    // Get current values from inputs
                    const inputs = document.querySelectorAll(`[data-asset="${assetIndex}"]`);
                    const updates = {};

                    inputs.forEach(input => {
                        const prop = input.dataset.prop;
                        if (input.type === 'checkbox') {
                            updates[prop] = input.checked;
                        } else if (input.type === 'number') {
                            updates[prop] = parseInt(input.value) || 0;
                        } else {
                            updates[prop] = input.value;
                        }
                    });

                    // Update properties in MyGeotab
                    await updateDeviceProperties(asset.id, updates);

                    // Update local data
                    asset.properties = updates;
                    delete assetChanges[assetIndex];

                    updateAssetStatus(`Saved changes for ${asset.name}`, 'success');

                } catch (error) {
                    console.error('Error saving asset:', error);
                    updateAssetStatus(`Error saving ${asset.name}: ${error.message}`, 'error');
                }
            }

            async function saveAllAssets() {
                const saveAllBtn = document.getElementById('saveAllAssetsBtn');
                const changedIndices = Object.keys(assetChanges).map(k => parseInt(k));

                if (changedIndices.length === 0) {
                    updateAssetStatus('No changes to save.', 'info');
                    return;
                }

                try {
                    saveAllBtn.disabled = true;
                    saveAllBtn.innerHTML = '<span class="loading-spinner"></span> Saving...';
                    updateAssetStatus(`Saving changes for ${changedIndices.length} assets...`, 'info');

                    let successCount = 0;
                    let errorCount = 0;

                    for (const index of changedIndices) {
                        try {
                            await saveAsset(index);
                            successCount++;
                        } catch (error) {
                            errorCount++;
                            console.error(`Failed to save asset ${index}:`, error);
                        }
                    }

                    if (errorCount === 0) {
                        updateAssetStatus(`Successfully saved ${successCount} assets!`, 'success');
                        assetChanges = {};
                    } else {
                        updateAssetStatus(`Saved ${successCount} assets with ${errorCount} errors.`, 'warning');
                    }

                } catch (error) {
                    console.error('Error saving all assets:', error);
                    updateAssetStatus(`Error: ${error.message}`, 'error');
                } finally {
                    saveAllBtn.disabled = false;
                    saveAllBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save All Changes';
                }
            }

            async function updateDeviceProperties(deviceId, properties) {
                console.log('updateDeviceProperties called for device:', deviceId);
                console.log('Properties to update:', properties);

                // Get the current device with all properties
                const devices = await new Promise((resolve, reject) => {
                    api.call('Get', {
                        typeName: 'Device',
                        search: { id: deviceId }
                    }, resolve, reject);
                });

                if (!devices || devices.length === 0) {
                    throw new Error('Device not found');
                }

                const device = devices[0];
                console.log('Device retrieved:', device.name);
                console.log('Device object before update:', device);
                console.log('Device keys:', Object.keys(device));
                console.log('Checking for existing custom properties:');
                console.log('  device.Bookable:', device.Bookable);
                console.log('  device.AllowRecurringBooking:', device.AllowRecurringBooking);
                console.log('  device.Approvers:', device.Approvers);

                // Map our property keys to the internal names defined in REQUIRED_PROPERTIES
                const propMap = {
                    'bookable': 'Bookable',
                    'recurring': 'AllowRecurringBooking',
                    'approvers': 'Approvers',
                    'fleetManagers': 'FleetManagers',
                    'conflicts': 'AllowConflicts',
                    'windowDays': 'BookingWindowInDays',
                    'maxDurationHours': 'MaximumDurationInHours',
                    'language': 'MailboxLanguage'
                };

                // Update each property on the device object
                for (const [key, value] of Object.entries(properties)) {
                    const internalName = propMap[key];
                    if (!internalName) {
                        console.warn('Unknown property key:', key);
                        continue;
                    }

                    // Set the property value directly on the device object
                    // MyGeotab stores custom property values as direct fields using the internalName
                    if (typeof value === 'boolean') {
                        device[internalName] = value;
                        console.log(`Set device.${internalName} = ${value} (boolean)`);
                    } else if (typeof value === 'number') {
                        device[internalName] = value;
                        console.log(`Set device.${internalName} = ${value} (number)`);
                    } else {
                        device[internalName] = value ? value.toString() : '';
                        console.log(`Set device.${internalName} = "${value}" (string)`);
                    }
                }

                console.log('Device object after update:', device);
                console.log('Device object after update - stringified:', JSON.stringify(device, null, 2));
                console.log('Calling MyGeotab Set API to save device...');

                // Save the updated device
                try {
                    const result = await new Promise((resolve, reject) => {
                        api.call('Set', {
                            typeName: 'Device',
                            entity: device
                        }, (result) => {
                            console.log('Set API success callback, result:', result);
                            resolve(result);
                        }, (error) => {
                            console.error('Set API error callback, error:', error);
                            reject(error);
                        });
                    });

                    console.log('MyGeotab Set API result:', result);
                    console.log('Device properties saved successfully');

                    // Verify the save by re-fetching the device
                    console.log('Verifying save by re-fetching device...');
                    const verifyDevices = await new Promise((resolve, reject) => {
                        api.call('Get', {
                            typeName: 'Device',
                            search: { id: deviceId }
                        }, resolve, reject);
                    });

                    if (verifyDevices && verifyDevices.length > 0) {
                        const verifiedDevice = verifyDevices[0];
                        console.log('Verified device - Bookable:', verifiedDevice.Bookable);
                        console.log('Verified device - AllowRecurringBooking:', verifiedDevice.AllowRecurringBooking);
                        console.log('Verified device - Approvers:', verifiedDevice.Approvers);
                    }
                } catch (error) {
                    console.error('Error in Set API call:', error);
                    throw error;
                }
            }

            // Webhook URL management functions
            function loadWebhookUrl() {
                const savedUrl = localStorage.getItem('fleetSyncWebhookUrl');
                const webhookInput = document.getElementById('webhookUrl');
                const triggerBtn = document.getElementById('triggerSyncBtn');

                if (savedUrl && webhookInput) {
                    webhookInput.value = savedUrl;
                    if (triggerBtn) triggerBtn.disabled = false;
                }
            }

            function saveWebhookUrl() {
                const webhookInput = document.getElementById('webhookUrl');
                const triggerBtn = document.getElementById('triggerSyncBtn');
                const url = webhookInput.value.trim();

                if (!url) {
                    updateSyncStatus('Please enter a webhook URL.', 'error');
                    return;
                }

                // Basic URL validation
                try {
                    new URL(url);
                } catch (e) {
                    updateSyncStatus('Invalid URL format. Please enter a valid webhook URL.', 'error');
                    return;
                }

                localStorage.setItem('fleetSyncWebhookUrl', url);
                if (triggerBtn) triggerBtn.disabled = false;
                updateSyncStatus('Webhook URL saved successfully.', 'success');
            }

            async function triggerSync() {
                const webhookUrl = localStorage.getItem('fleetSyncWebhookUrl');
                const triggerBtn = document.getElementById('triggerSyncBtn');
                const syncProgress = document.getElementById('syncProgress');
                const syncResultContainer = document.getElementById('syncResultContainer');
                const syncResult = document.getElementById('syncResult');

                if (!webhookUrl) {
                    updateSyncStatus('Please save a webhook URL first.', 'error');
                    return;
                }

                try {
                    triggerBtn.disabled = true;
                    syncProgress.style.display = 'inline-flex';
                    syncProgress.style.alignItems = 'center';
                    syncProgress.style.gap = '8px';
                    syncResultContainer.style.display = 'none';
                    updateSyncStatus('Triggering synchronisation...', 'info');

                    // Use no-cors mode since Azure Automation webhooks don't support CORS
                    const response = await fetch(webhookUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            source: 'MyGeotab Add-In',
                            timestamp: new Date().toISOString()
                        })
                    });

                    // With no-cors mode, we can't read the response, but the request was sent
                    updateSyncStatus('Sync request sent successfully!', 'success');
                    syncResult.textContent = 'Webhook request sent to Azure Automation.\n\n' +
                        'Due to CORS limitations, we cannot verify the response.\n' +
                        'Please check Azure Automation job history to confirm execution:\n' +
                        '1. Go to Azure Portal\n' +
                        '2. Navigate to your Automation Account\n' +
                        '3. Select "Jobs" under Process Automation\n' +
                        '4. Look for the most recent job\n\n' +
                        'Timestamp: ' + new Date().toLocaleString();
                    syncResultContainer.style.display = 'block';

                } catch (error) {
                    console.error('Sync error:', error);

                    // Check if it's a CORS error
                    if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
                        updateSyncStatus('Request sent (CORS limitation)', 'warning');
                        syncResult.textContent = 'The webhook request was sent, but we cannot verify the response due to CORS restrictions.\n\n' +
                            'This is normal for Azure Automation webhooks.\n\n' +
                            'To verify execution:\n' +
                            '1. Check Azure Automation job history in Azure Portal\n' +
                            '2. Look for a job that started around: ' + new Date().toLocaleString() + '\n\n' +
                            'Consider using Azure Logic Apps or Azure Functions as a CORS-enabled proxy for better feedback.';
                        syncResultContainer.style.display = 'block';
                    } else {
                        updateSyncStatus(`Error: ${error.message}`, 'error');
                        syncResult.textContent = `Failed to trigger sync: ${error.message}`;
                        syncResultContainer.style.display = 'block';
                    }
                } finally {
                    triggerBtn.disabled = false;
                    syncProgress.style.display = 'none';
                }
            }

            function updateSyncStatus(message, type) {
                const statusDiv = document.getElementById('syncStatusMessage');
                if (!statusDiv) return;

                statusDiv.className = `status-message status-${type}`;
                const icon = getStatusIcon(type);
                statusDiv.innerHTML = `${icon}<span>${message}</span>`;
            }

            return {
                initialize: initialize,
                focus: focus,
                blur: blur
            };
        };
        })();
    </script>
</body>
</html>

