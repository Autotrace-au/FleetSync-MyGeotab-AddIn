<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetSync Property Manager</title>
</head>
<body>
    <script>
        // Inject CSS dynamically to bypass MyGeotab's style tag stripping
        (function() {
            const css = `
/* Scoped CSS for MyGeotab Add-In - All selectors prefixed with #fleetSyncAddin */
#fleetSyncAddin {
    /* CSS Variables scoped to the add-in */
    --primary-color: #2563eb;
    --primary-dark: #1e40af;
    --primary-light: #3b82f6;
    --success-color: #10b981;
    --success-dark: #059669;
    --warning-color: #f59e0b;
    --warning-dark: #d97706;
    --error-color: #ef4444;
    --error-dark: #dc2626;
    --info-color: #06b6d4;
    --info-dark: #0891b2;
    --secondary-color: #64748b;
    --secondary-dark: #475569;
    --light-bg: #f8fafc;
    --card-bg: #ffffff;
    --border-color: #e2e8f0;
    --text-color: #0f172a;
    --text-muted: #64748b;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    font-size: 14px;
    line-height: 1.6;
    color: var(--text-color);
    background-color: #f1f5f9;
    min-height: 100vh;
    box-sizing: border-box;
}
#fleetSyncAddin *, #fleetSyncAddin *::before, #fleetSyncAddin *::after { box-sizing: border-box; }
#fleetSyncAddin .container { max-width: 100%; margin: 0; background-color: var(--card-bg); min-height: 100vh; }
#fleetSyncAddin header { background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); color: white; padding: 32px 40px; position: relative; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
#fleetSyncAddin header::before { content: ''; position: absolute; top: -50%; right: -10%; width: 300px; height: 300px; background: rgba(255, 255, 255, 0.08); border-radius: 50%; }
#fleetSyncAddin .header-content { max-width: 900px; margin: 0 auto; }
#fleetSyncAddin header h1 { font-size: 32px; font-weight: 700; margin-bottom: 8px; position: relative; z-index: 1; }
#fleetSyncAddin .subtitle { font-size: 16px; opacity: 0.9; position: relative; z-index: 1; }
#fleetSyncAddin .content-wrapper { padding: 30px 40px; max-width: 900px; margin: 0 auto; }
#fleetSyncAddin section { margin-bottom: 30px; padding: 24px; background-color: var(--light-bg); border-radius: 12px; border: 1px solid var(--border-color); transition: all 0.3s ease; }
#fleetSyncAddin section:hover { box-shadow: var(--shadow-md); }
#fleetSyncAddin section h2 { font-size: 20px; font-weight: 700; margin-bottom: 16px; color: var(--text-color); display: flex; align-items: center; gap: 10px; }
#fleetSyncAddin section h2::before { content: ''; width: 4px; height: 24px; background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); border-radius: 2px; }
#fleetSyncAddin .info-text { color: var(--text-muted); margin-bottom: 20px; line-height: 1.7; }
#fleetSyncAddin .status-section { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-color: #bae6fd; }
#fleetSyncAddin .status-message { padding: 16px 20px; border-radius: 10px; font-weight: 500; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow-sm); animation: slideIn 0.3s ease; }
@keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
#fleetSyncAddin .status-message svg { max-width: 20px; max-height: 20px; flex-shrink: 0; display: block; }
#fleetSyncAddin .status-info { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e40af; border: 1px solid #93c5fd; }
#fleetSyncAddin .status-info svg { stroke: #1e40af; fill: none; }
#fleetSyncAddin .status-success { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46; border: 1px solid #6ee7b7; }
#fleetSyncAddin .status-success svg { stroke: #065f46; fill: none; }
#fleetSyncAddin .status-warning { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e; border: 1px solid #fcd34d; }
#fleetSyncAddin .status-warning svg { stroke: #92400e; fill: none; }
#fleetSyncAddin .status-error { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #991b1b; border: 1px solid #fca5a5; }
#fleetSyncAddin .status-error svg { stroke: #991b1b; fill: none; }
#fleetSyncAddin .property-list { display: grid; gap: 16px; }
#fleetSyncAddin .property-item { display: flex; align-items: flex-start; padding: 20px; background-color: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); transition: all 0.3s ease; box-shadow: var(--shadow-sm); }
#fleetSyncAddin .property-item:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); border-color: var(--primary-light); }
#fleetSyncAddin .property-icon { width: 48px; height: 48px; margin-right: 18px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #e0e7ff 0%, #ddd6fe 100%); border-radius: 12px; padding: 10px; }
#fleetSyncAddin .property-icon svg { max-width: 28px; max-height: 28px; stroke: var(--primary-color); display: block; }
#fleetSyncAddin .property-details { flex: 1; }
#fleetSyncAddin .property-details h3 { font-size: 17px; font-weight: 600; margin-bottom: 8px; color: var(--text-color); }
#fleetSyncAddin .property-details p { font-size: 14px; color: var(--text-muted); margin-bottom: 12px; line-height: 1.6; }
#fleetSyncAddin .property-status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; background-color: var(--light-bg); color: var(--text-muted); border: 1px solid var(--border-color); transition: all 0.2s ease; }
#fleetSyncAddin .property-status-badge.status-exists { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46; border-color: #6ee7b7; }
#fleetSyncAddin .property-status-badge.status-missing { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e; border-color: #fcd34d; }
#fleetSyncAddin .actions-section { display: flex; gap: 12px; flex-wrap: wrap; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); padding: 24px; border: 1px solid var(--border-color); }
#fleetSyncAddin .btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; font-size: 14px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; text-decoration: none; box-shadow: var(--shadow-sm); position: relative; overflow: hidden; }
#fleetSyncAddin .btn svg { max-width: 18px; max-height: 18px; stroke: currentColor; display: block; }
#fleetSyncAddin .btn::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%; background: rgba(255, 255, 255, 0.3); transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s; }
#fleetSyncAddin .btn:hover:not(:disabled)::before { width: 300px; height: 300px; }
#fleetSyncAddin .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
#fleetSyncAddin .btn:active:not(:disabled) { transform: translateY(0); }
#fleetSyncAddin .btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }
#fleetSyncAddin .btn-primary { background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); color: #ffffff; }
#fleetSyncAddin .btn-primary:hover:not(:disabled) { background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-color) 100%); }
#fleetSyncAddin .btn-success { background: linear-gradient(135deg, var(--success-color) 0%, var(--success-dark) 100%); color: #ffffff; }
#fleetSyncAddin .btn-success:hover:not(:disabled) { background: linear-gradient(135deg, #34d399 0%, var(--success-color) 100%); }
#fleetSyncAddin .btn-secondary { background: linear-gradient(135deg, var(--secondary-color) 0%, var(--secondary-dark) 100%); color: #ffffff; }
#fleetSyncAddin .btn-secondary:hover:not(:disabled) { background: linear-gradient(135deg, #94a3b8 0%, var(--secondary-color) 100%); }
#fleetSyncAddin .help-section { background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); border-color: #c4b5fd; }
#fleetSyncAddin .help-section ul { margin-left: 20px; margin-top: 12px; margin-bottom: 12px; }
#fleetSyncAddin .help-section li { margin-bottom: 8px; color: var(--text-color); }
#fleetSyncAddin .help-link { margin-top: 16px; }
#fleetSyncAddin .help-link a { color: var(--primary-color); text-decoration: none; font-weight: 600; transition: all 0.2s ease; border-bottom: 2px solid transparent; }
#fleetSyncAddin .help-link a:hover { color: var(--primary-dark); border-bottom-color: var(--primary-color); }
#fleetSyncAddin .tab-navigation { display: flex; gap: 0; background-color: var(--card-bg); border-bottom: 2px solid var(--border-color); padding: 0 40px; margin: 0; box-shadow: var(--shadow-sm); }
#fleetSyncAddin .tab-button { padding: 16px 24px; font-size: 15px; font-weight: 600; color: var(--text-muted); background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; transition: all 0.3s ease; position: relative; }
#fleetSyncAddin .tab-button:hover { color: var(--primary-color); background-color: var(--light-bg); }
#fleetSyncAddin .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); background-color: var(--light-bg); }
#fleetSyncAddin .tab-content { display: none; }
#fleetSyncAddin .tab-content.active { display: block; }
#fleetSyncAddin .asset-table-container { overflow-x: auto; background-color: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); }
#fleetSyncAddin .asset-table { width: 100%; border-collapse: collapse; }
#fleetSyncAddin .asset-table thead { background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); color: white; }
#fleetSyncAddin .asset-table th { padding: 14px 12px; text-align: left; font-weight: 600; font-size: 13px; white-space: nowrap; }
#fleetSyncAddin .asset-table td { padding: 12px; border-bottom: 1px solid var(--border-color); font-size: 13px; }
#fleetSyncAddin .asset-table tbody tr:hover { background-color: var(--light-bg); }
#fleetSyncAddin .asset-table tbody tr:last-child td { border-bottom: none; }
#fleetSyncAddin .asset-table input[type="text"], #fleetSyncAddin .asset-table input[type="number"] { width: 100%; padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px; transition: all 0.2s ease; }
#fleetSyncAddin .asset-table input[type="text"]:focus, #fleetSyncAddin .asset-table input[type="number"]:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
#fleetSyncAddin .asset-table input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
#fleetSyncAddin .asset-table .asset-name { font-weight: 600; color: var(--text-color); }
#fleetSyncAddin .asset-table .asset-serial { color: var(--text-muted); font-size: 12px; }
#fleetSyncAddin .save-btn-cell { text-align: center; }
#fleetSyncAddin .btn-save { padding: 6px 16px; font-size: 12px; }
#fleetSyncAddin .loading-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
#fleetSyncAddin footer { margin-top: 0; padding: 24px 40px; border-top: 1px solid var(--border-color); text-align: center; color: var(--text-muted); font-size: 12px; background-color: var(--light-bg); }
#fleetSyncAddin .footer-content { max-width: 900px; margin: 0 auto; }
@media (max-width: 768px) {
    #fleetSyncAddin { padding: 10px; }
    #fleetSyncAddin header { padding: 30px 20px; }
    #fleetSyncAddin .content-wrapper { padding: 20px; }
    #fleetSyncAddin section { padding: 16px; }
    #fleetSyncAddin .property-item { flex-direction: column; text-align: center; }
    #fleetSyncAddin .property-icon { margin-right: 0; margin-bottom: 12px; }
    #fleetSyncAddin footer { padding: 20px; }
}
`;
            const style = document.createElement('style');
            style.textContent = css;
            document.head.appendChild(style);
        })();
    </script>
    <div id="fleetSyncAddin">
    <div class="container">
        <header>
            <div class="header-content">
                <h1>FleetSync Property Manager</h1>
                <p class="subtitle">Manage custom properties for FleetSync equipment mailbox automation</p>
            </div>
        </header>

        <nav class="tab-navigation">
            <button class="tab-button active" data-tab="properties">Property Setup</button>
            <button class="tab-button" data-tab="assets">Manage Assets</button>
        </nav>

        <div class="content-wrapper tab-content active" id="propertiesTab">
            <section class="status-section">
            <h2>Status</h2>
            <div id="statusMessage" class="status-message status-info">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                <span>Ready. Click "Check Properties" to scan for existing custom properties.</span>
            </div>
            <div id="propertyStatus" class="property-status"></div>
        </section>

        <section class="properties-section">
            <h2>Required Custom Properties</h2>
            <p class="info-text">
                These custom properties are required by the FleetSync orchestrator to manage Exchange equipment mailboxes.
                Click "Check Properties" to verify which properties exist, then "Create Missing Properties" to add any that are missing.
            </p>

            <div class="property-list">
                <!-- Booking Configuration -->
                <div class="property-item">
                    <div class="property-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 11l3 3L22 4"></path>
                            <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
                        </svg>
                    </div>
                    <div class="property-details">
                        <h3>Enable Equipment Booking</h3>
                        <p>Boolean (Toggle) - Allow this equipment to be booked through Outlook/Teams calendar</p>
                        <span class="property-status-badge" data-property="Bookable">Not checked</span>
                    </div>
                </div>

                <div class="property-item">
                    <div class="property-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <polyline points="1 20 1 14 7 14"></polyline>
                            <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"></path>
                        </svg>
                    </div>
                    <div class="property-details">
                        <h3>Allow Recurring Bookings</h3>
                        <p>Boolean (Toggle) - Permit users to create recurring/repeating bookings</p>
                        <span class="property-status-badge" data-property="AllowRecurringBooking">Not checked</span>
                    </div>
                </div>

                <div class="property-item">
                    <div class="property-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 00-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 010 7.75"></path>
                        </svg>
                    </div>
                    <div class="property-details">
                        <h3>Booking Approvers</h3>
                        <p>Text - Email addresses of people who must approve booking requests (semicolon-separated)</p>
                        <span class="property-status-badge" data-property="Approvers">Not checked</span>
                    </div>
                </div>

                <div class="property-item">
                    <div class="property-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="property-details">
                        <h3>Fleet Managers</h3>
                        <p>Text - Email addresses of fleet managers who need full calendar access (semicolon-separated)</p>
                        <span class="property-status-badge" data-property="FleetManagers">Not checked</span>
                    </div>
                </div>

                <div class="property-item">
                    <div class="property-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                        </svg>
                    </div>
                    <div class="property-details">
                        <h3>Allow Double Booking</h3>
                        <p>Boolean (Toggle) - Allow multiple bookings at the same time (normally disabled)</p>
                        <span class="property-status-badge" data-property="AllowConflicts">Not checked</span>
                    </div>
                </div>

                <div class="property-item">
                    <div class="property-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                    </div>
                    <div class="property-details">
                        <h3>Booking Window (Days)</h3>
                        <p>Number - How many days in advance users can book this equipment (e.g., 90)</p>
                        <span class="property-status-badge" data-property="BookingWindowInDays">Not checked</span>
                    </div>
                </div>

                <div class="property-item">
                    <div class="property-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                    </div>
                    <div class="property-details">
                        <h3>Maximum Booking Duration (Hours)</h3>
                        <p>Number - Maximum length of a single booking in hours (e.g., 8)</p>
                        <span class="property-status-badge" data-property="MaximumDurationInHours">Not checked</span>
                    </div>
                </div>

                <!-- Regional Settings -->
                <div class="property-item">
                    <div class="property-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M2 12h20"></path>
                            <path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"></path>
                        </svg>
                    </div>
                    <div class="property-details">
                        <h3>Mailbox Language</h3>
                        <p>Text - Language code for booking confirmation emails (e.g., en-AU, en-US)</p>
                        <span class="property-status-badge" data-property="MailboxLanguage">Not checked</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="actions-section">
            <button id="checkPropertiesBtn" class="btn btn-primary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="M21 21l-4.35-4.35"></path>
                </svg>
                Check Properties
            </button>
            <button id="createPropertiesBtn" class="btn btn-success" disabled>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Create Missing Properties
            </button>
            <button id="refreshBtn" class="btn btn-secondary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"></path>
                </svg>
                Refresh
            </button>
        </section>

        <section class="help-section">
            <h2>About FleetSync</h2>
            <p>
                FleetSync creates and configures Exchange equipment mailboxes for vehicles and trailers, 
                sourced from MyGeotab assets, using an Azure Automation runbook orchestrator so staff can 
                book cars and trailers in Outlook.
            </p>
            <p>
                These custom properties allow the FleetSync orchestrator to:
            </p>
            <ul>
                <li>Control booking availability and permissions</li>
                <li>Set resource location and identification details</li>
                <li>Configure approval workflows</li>
                <li>Manage recurring booking policies</li>
            </ul>
            <p class="help-link">
                For more information, visit the 
                <a href="https://github.com/Autotrace-au/AHC-AssetCreator" target="_blank">FleetSync repository</a>.
            </p>
        </section>
        </div>

        <!-- Assets Tab -->
        <div class="content-wrapper tab-content" id="assetsTab">
            <section class="status-section">
                <h2>Asset Management</h2>
                <div id="assetStatusMessage" class="status-message status-info">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    <span>Click "Load Assets" to fetch all devices from MyGeotab and manage their booking properties.</span>
                </div>
            </section>

            <section class="actions-section">
                <button id="loadAssetsBtn" class="btn btn-primary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"></path>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                    </svg>
                    Load Assets
                </button>
                <button id="saveAllAssetsBtn" class="btn btn-success" disabled>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save All Changes
                </button>
            </section>

            <section class="properties-section">
                <h2>Assets</h2>
                <p class="info-text">
                    Edit booking properties for each asset below. Changes are saved individually or you can save all at once.
                </p>
                <div id="assetTableContainer" class="asset-table-container" style="display: none;">
                    <table class="asset-table">
                        <thead>
                            <tr>
                                <th>Asset</th>
                                <th>Bookable</th>
                                <th>Recurring</th>
                                <th>Approvers</th>
                                <th>Fleet Managers</th>
                                <th>Conflicts</th>
                                <th>Window (Days)</th>
                                <th>Max Duration (Hrs)</th>
                                <th>Language</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="assetTableBody">
                            <!-- Asset rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <footer>
            <div class="footer-content">
                <p>&copy; 2025 Autotrace. All rights reserved.</p>
            </div>
        </footer>
    </div>
    </div>

    <script>
        /**
         * FleetSync Property Manager Add-In
         */
        (function() {
            // Ensure geotab object exists
            if (typeof geotab === 'undefined') {
                window.geotab = {};
            }
            if (typeof geotab.addin === 'undefined') {
                geotab.addin = {};
            }

            geotab.addin.fleetSyncPropertyManager = () => {
            let api;
            let state;

            const REQUIRED_PROPERTIES = [
                // Booking Configuration
                { name: 'Enable Equipment Booking', internalName: 'Bookable', description: 'Allow this equipment to be booked through Outlook/Teams calendar. When enabled, an Exchange mailbox will be created and configured for booking. Default: false (not bookable)', dataType: 'Boolean' },
                { name: 'Allow Recurring Bookings', internalName: 'AllowRecurringBooking', description: 'Permit users to create recurring/repeating bookings for this equipment (e.g., weekly bookings). Default: false (no recurring)', dataType: 'Boolean' },
                { name: 'Booking Approvers', internalName: 'Approvers', description: 'Email addresses of people who must approve booking requests (semicolon-separated). Default: blank (auto-accept, no approval required). Example: manager@company.com.au;supervisor@company.com.au', dataType: 'String' },
                { name: 'Fleet Managers', internalName: 'FleetManagers', description: 'Email addresses of fleet managers who need full calendar access to view and manage all bookings (semicolon-separated). Default: blank (no fleet managers). Example: fleet@company.com.au', dataType: 'String' },
                { name: 'Allow Double Booking', internalName: 'AllowConflicts', description: 'Allow multiple bookings at the same time (double-booking). Normally disabled to prevent scheduling conflicts. Default: false (no conflicts)', dataType: 'Boolean' },
                { name: 'Booking Window (Days)', internalName: 'BookingWindowInDays', description: 'How many days in advance users can book this equipment. Default: 90 days. Example: 90 means users can book up to 90 days ahead.', dataType: 'Integer' },
                { name: 'Maximum Booking Duration (Hours)', internalName: 'MaximumDurationInHours', description: 'Maximum length of a single booking in hours. Default: 24 hours. Example: 24 means bookings cannot exceed 24 hours (1 day).', dataType: 'Integer' },

                // Regional Settings
                { name: 'Mailbox Language', internalName: 'MailboxLanguage', description: 'Language code for booking confirmation emails. Default: en-AU (Australian English). Other examples: en-US, en-GB.', dataType: 'String' }
            ];

            let existingProperties = [];
            let missingProperties = [];

            function initialize(apiInstance, stateInstance, callback) {
                api = apiInstance;
                state = stateInstance;
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', setupEventListeners);
                } else {
                    setupEventListeners();
                }
                callback();
            }

            function focus(apiInstance, stateInstance) {
                api = apiInstance;
                state = stateInstance;
                updateStatus('Ready. Click "Check Properties" to scan for existing custom properties.', 'info');
            }

            function blur(apiInstance, stateInstance) {}

            function setupEventListeners() {
                const checkBtn = document.getElementById('checkPropertiesBtn');
                const createBtn = document.getElementById('createPropertiesBtn');
                const refreshBtn = document.getElementById('refreshBtn');
                const loadAssetsBtn = document.getElementById('loadAssetsBtn');
                const saveAllAssetsBtn = document.getElementById('saveAllAssetsBtn');

                if (checkBtn) checkBtn.addEventListener('click', checkProperties);
                if (createBtn) createBtn.addEventListener('click', createMissingProperties);
                if (refreshBtn) refreshBtn.addEventListener('click', refreshPage);
                if (loadAssetsBtn) loadAssetsBtn.addEventListener('click', loadAssets);
                if (saveAllAssetsBtn) saveAllAssetsBtn.addEventListener('click', saveAllAssets);

                // Tab switching
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', () => switchTab(button.dataset.tab));
                });
            }

            function switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabName);
                });

                // Update tab content
                document.getElementById('propertiesTab').classList.toggle('active', tabName === 'properties');
                document.getElementById('assetsTab').classList.toggle('active', tabName === 'assets');
            }

            function getStatusIcon(type) {
                const icons = {
                    info: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>',
                    success: '<svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
                    warning: '<svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
                    error: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>'
                };
                return icons[type] || icons.info;
            }

            function updateStatus(message, type = 'info') {
                const statusElement = document.getElementById('statusMessage');
                if (statusElement) {
                    statusElement.innerHTML = getStatusIcon(type) + '<span>' + message + '</span>';
                    statusElement.className = `status-message status-${type}`;
                }
            }

            function updatePropertyBadges() {
                REQUIRED_PROPERTIES.forEach(prop => {
                    const badge = document.querySelector(`[data-property="${prop.internalName}"]`);
                    if (badge) {
                        const exists = existingProperties.some(ep => ep.name.toLowerCase() === prop.name.toLowerCase());
                        if (exists) {
                            badge.textContent = 'Exists';
                            badge.className = 'property-status-badge status-exists';
                        } else {
                            badge.textContent = 'Missing';
                            badge.className = 'property-status-badge status-missing';
                        }
                    }
                });
            }

            async function checkProperties() {
                updateStatus('Checking existing custom properties...', 'info');
                const checkBtn = document.getElementById('checkPropertiesBtn');
                const createBtn = document.getElementById('createPropertiesBtn');
                if (checkBtn) checkBtn.disabled = true;

                try {
                    const properties = await new Promise((resolve, reject) => {
                        api.call('Get', { typeName: 'Property', search: {} }, resolve, reject);
                    });

                    existingProperties = properties || [];

                    // Log a sample property to see its structure
                    if (existingProperties.length > 0) {
                        console.log('Sample existing property structure:', JSON.stringify(existingProperties[0], null, 2));
                    }

                    missingProperties = REQUIRED_PROPERTIES.filter(reqProp => {
                        return !existingProperties.some(existProp => existProp.name.toLowerCase() === reqProp.name.toLowerCase());
                    });

                    updatePropertyBadges();

                    if (missingProperties.length === 0) {
                        updateStatus('All required properties exist!', 'success');
                        if (createBtn) createBtn.disabled = true;
                    } else {
                        updateStatus(`Found ${existingProperties.length} properties. ${missingProperties.length} required properties are missing.`, 'warning');
                        if (createBtn) createBtn.disabled = false;
                    }
                } catch (error) {
                    console.error('Error checking properties:', error);
                    updateStatus(`Error: ${error.message || 'Failed to check properties'}`, 'error');
                } finally {
                    if (checkBtn) checkBtn.disabled = false;
                }
            }

            async function createMissingProperties() {
                if (missingProperties.length === 0) {
                    updateStatus('No missing properties to create.', 'info');
                    return;
                }

                updateStatus('Creating FleetSync PropertySet...', 'info');
                const createBtn = document.getElementById('createPropertiesBtn');
                if (createBtn) createBtn.disabled = true;

                let successCount = 0;
                let errorCount = 0;

                try {
                    // First, check if FleetSync PropertySet exists
                    let propertySet;
                    try {
                        const propertySets = await new Promise((resolve, reject) => {
                            api.call('Get', {
                                typeName: 'PropertySet',
                                search: { name: 'FleetSync Properties' }
                            }, resolve, reject);
                        });

                        if (propertySets && propertySets.length > 0) {
                            propertySet = propertySets[0];
                            console.log('Found existing FleetSync PropertySet:', propertySet);
                        }
                    } catch (error) {
                        console.log('PropertySet not found, will create new one');
                    }

                    // Create PropertySet if it doesn't exist
                    if (!propertySet) {
                        updateStatus('Creating FleetSync PropertySet...', 'info');
                        try {
                            const propertySetEntity = {
                                name: 'FleetSync Properties',
                                description: 'Custom properties for FleetSync equipment mailbox automation'
                            };

                            propertySet = await new Promise((resolve, reject) => {
                                api.call('Add', {
                                    typeName: 'PropertySet',
                                    entity: propertySetEntity
                                }, resolve, reject);
                            });

                            console.log('Created PropertySet:', propertySet);
                        } catch (error) {
                            console.error('Failed to create PropertySet:', error);
                            updateStatus(`Error: Failed to create PropertySet - ${error.message || error}`, 'error');
                            if (createBtn) createBtn.disabled = false;
                            return;
                        }
                    }

                    // Now create the properties with the PropertySet
                    updateStatus(`Creating ${missingProperties.length} missing properties...`, 'info');

                    // PropertySet ID might be returned as a string or an object with id property
                    const propertySetId = typeof propertySet === 'string' ? propertySet : propertySet.id;
                    console.log('Using PropertySet ID:', propertySetId);

                    for (const prop of missingProperties) {
                        try {
                            // MyGeotab Property entity structure
                            const propertyEntity = {
                                name: prop.name,
                                description: prop.description,
                                propertySet: { id: propertySetId },
                                entityTypes: ['Device'],
                                propertyType: prop.dataType  // Use dataType directly: 'Boolean', 'Number', or 'String'
                            };

                            console.log('Creating property:', prop.name, 'with propertyType:', prop.dataType);
                            console.log('Property entity:', JSON.stringify(propertyEntity, null, 2));

                            await new Promise((resolve, reject) => {
                                api.call('Add', { typeName: 'Property', entity: propertyEntity }, resolve, reject);
                            });

                            successCount++;
                            console.log(`Created property: ${prop.name}`);
                        } catch (error) {
                            errorCount++;
                            console.error(`Failed to create property ${prop.name}:`, error);
                        }
                    }

                    if (errorCount === 0) {
                        updateStatus(`Successfully created ${successCount} properties!`, 'success');
                    } else {
                        updateStatus(`Created ${successCount} properties with ${errorCount} errors. Check console for details.`, 'warning');
                    }

                    setTimeout(() => checkProperties(), 1000);
                } catch (error) {
                    console.error('Error creating properties:', error);
                    updateStatus(`Error: ${error.message || 'Failed to create properties'}`, 'error');
                }
            }

            function refreshPage() {
                existingProperties = [];
                missingProperties = [];
                const badges = document.querySelectorAll('.property-status-badge');
                badges.forEach(badge => {
                    badge.textContent = 'Not checked';
                    badge.className = 'property-status-badge';
                });
                updateStatus('Ready. Click "Check Properties" to scan for existing custom properties.', 'info');
                const createBtn = document.getElementById('createPropertiesBtn');
                if (createBtn) createBtn.disabled = true;
            }

            // Asset Management Functions
            let allAssets = [];
            let assetChanges = {};

            function updateAssetStatus(message, type = 'info') {
                const statusElement = document.getElementById('assetStatusMessage');
                if (statusElement) {
                    statusElement.innerHTML = getStatusIcon(type) + '<span>' + message + '</span>';
                    statusElement.className = `status-message status-${type}`;
                }
            }

            async function loadAssets() {
                const loadBtn = document.getElementById('loadAssetsBtn');
                const saveAllBtn = document.getElementById('saveAllAssetsBtn');
                const tableContainer = document.getElementById('assetTableContainer');

                try {
                    loadBtn.disabled = true;
                    loadBtn.innerHTML = '<span class="loading-spinner"></span> Loading...';
                    updateAssetStatus('Loading assets from MyGeotab...', 'info');

                    // Get all devices with their custom properties
                    const devices = await new Promise((resolve, reject) => {
                        api.call('Get', {
                            typeName: 'Device',
                            resultsLimit: 5000
                        }, resolve, reject);
                    });

                    allAssets = devices.map(device => {
                        return {
                            id: device.id,
                            name: device.name,
                            serialNumber: device.serialNumber,
                            device: device,  // Store full device object
                            properties: getDeviceProperties(device)
                        };
                    });

                    renderAssetTable();
                    tableContainer.style.display = 'block';
                    saveAllBtn.disabled = false;
                    updateAssetStatus(`Loaded ${allAssets.length} assets successfully.`, 'success');

                } catch (error) {
                    console.error('Error loading assets:', error);
                    updateAssetStatus(`Error: ${error.message || 'Failed to load assets'}`, 'error');
                } finally {
                    loadBtn.disabled = false;
                    loadBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg> Load Assets';
                }
            }

            function getDeviceProperties(device) {
                const props = {
                    bookable: false,
                    recurring: false,
                    approvers: '',
                    fleetManagers: '',
                    conflicts: false,
                    windowDays: 90,
                    maxDurationHours: 24,
                    language: 'en-AU'
                };

                // Custom properties are stored directly on the device object
                // Look for properties by their internal names
                if (device.bookable !== undefined) props.bookable = device.bookable === true || device.bookable === 'true';
                if (device.Bookable !== undefined) props.bookable = device.Bookable === true || device.Bookable === 'true';

                if (device.allowRecurringBooking !== undefined) props.recurring = device.allowRecurringBooking === true || device.allowRecurringBooking === 'true';
                if (device.AllowRecurringBooking !== undefined) props.recurring = device.AllowRecurringBooking === true || device.AllowRecurringBooking === 'true';

                if (device.approvers !== undefined) props.approvers = device.approvers || '';
                if (device.Approvers !== undefined) props.approvers = device.Approvers || '';

                if (device.fleetManagers !== undefined) props.fleetManagers = device.fleetManagers || '';
                if (device.FleetManagers !== undefined) props.fleetManagers = device.FleetManagers || '';

                if (device.allowConflicts !== undefined) props.conflicts = device.allowConflicts === true || device.allowConflicts === 'true';
                if (device.AllowConflicts !== undefined) props.conflicts = device.AllowConflicts === true || device.AllowConflicts === 'true';

                if (device.bookingWindowInDays !== undefined) props.windowDays = parseInt(device.bookingWindowInDays) || 90;
                if (device.BookingWindowInDays !== undefined) props.windowDays = parseInt(device.BookingWindowInDays) || 90;

                if (device.maximumDurationInHours !== undefined) props.maxDurationHours = parseInt(device.maximumDurationInHours) || 24;
                if (device.MaximumDurationInHours !== undefined) props.maxDurationHours = parseInt(device.MaximumDurationInHours) || 24;

                if (device.mailboxLanguage !== undefined) props.language = device.mailboxLanguage || 'en-AU';
                if (device.MailboxLanguage !== undefined) props.language = device.MailboxLanguage || 'en-AU';

                return props;
            }

            function renderAssetTable() {
                const tbody = document.getElementById('assetTableBody');
                tbody.innerHTML = '';

                allAssets.forEach((asset, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="asset-name">${escapeHtml(asset.name)}</div>
                            <div class="asset-serial">${escapeHtml(asset.serialNumber)}</div>
                        </td>
                        <td><input type="checkbox" data-asset="${index}" data-prop="bookable" ${asset.properties.bookable ? 'checked' : ''}></td>
                        <td><input type="checkbox" data-asset="${index}" data-prop="recurring" ${asset.properties.recurring ? 'checked' : ''}></td>
                        <td><input type="text" data-asset="${index}" data-prop="approvers" value="${escapeHtml(asset.properties.approvers)}" placeholder="email1;email2"></td>
                        <td><input type="text" data-asset="${index}" data-prop="fleetManagers" value="${escapeHtml(asset.properties.fleetManagers)}" placeholder="email1;email2"></td>
                        <td><input type="checkbox" data-asset="${index}" data-prop="conflicts" ${asset.properties.conflicts ? 'checked' : ''}></td>
                        <td><input type="number" data-asset="${index}" data-prop="windowDays" value="${asset.properties.windowDays}" min="1" max="365"></td>
                        <td><input type="number" data-asset="${index}" data-prop="maxDurationHours" value="${asset.properties.maxDurationHours}" min="1" max="720"></td>
                        <td><input type="text" data-asset="${index}" data-prop="language" value="${escapeHtml(asset.properties.language)}" placeholder="en-AU"></td>
                        <td class="save-btn-cell">
                            <button class="btn btn-primary btn-save" data-save-asset="${index}">Save</button>
                        </td>
                    `;
                    tbody.appendChild(row);

                    // Add change listeners
                    row.querySelectorAll('input').forEach(input => {
                        input.addEventListener('change', () => trackAssetChange(index));
                    });

                    // Add save button listener
                    const saveBtn = row.querySelector('[data-save-asset]');
                    if (saveBtn) {
                        saveBtn.addEventListener('click', () => saveAsset(index));
                    }
                });
            }

            function trackAssetChange(assetIndex) {
                assetChanges[assetIndex] = true;
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text || '';
                return div.innerHTML;
            }

            async function saveAsset(assetIndex) {
                const asset = allAssets[assetIndex];
                if (!asset) return;

                try {
                    // Get current values from inputs
                    const inputs = document.querySelectorAll(`[data-asset="${assetIndex}"]`);
                    const updates = {};

                    inputs.forEach(input => {
                        const prop = input.dataset.prop;
                        if (input.type === 'checkbox') {
                            updates[prop] = input.checked;
                        } else if (input.type === 'number') {
                            updates[prop] = parseInt(input.value) || 0;
                        } else {
                            updates[prop] = input.value;
                        }
                    });

                    // Update properties in MyGeotab
                    await updateDeviceProperties(asset.id, updates);

                    // Update local data
                    asset.properties = updates;
                    delete assetChanges[assetIndex];

                    updateAssetStatus(`Saved changes for ${asset.name}`, 'success');

                } catch (error) {
                    console.error('Error saving asset:', error);
                    updateAssetStatus(`Error saving ${asset.name}: ${error.message}`, 'error');
                }
            }

            async function saveAllAssets() {
                const saveAllBtn = document.getElementById('saveAllAssetsBtn');
                const changedIndices = Object.keys(assetChanges).map(k => parseInt(k));

                if (changedIndices.length === 0) {
                    updateAssetStatus('No changes to save.', 'info');
                    return;
                }

                try {
                    saveAllBtn.disabled = true;
                    saveAllBtn.innerHTML = '<span class="loading-spinner"></span> Saving...';
                    updateAssetStatus(`Saving changes for ${changedIndices.length} assets...`, 'info');

                    let successCount = 0;
                    let errorCount = 0;

                    for (const index of changedIndices) {
                        try {
                            await saveAsset(index);
                            successCount++;
                        } catch (error) {
                            errorCount++;
                            console.error(`Failed to save asset ${index}:`, error);
                        }
                    }

                    if (errorCount === 0) {
                        updateAssetStatus(`Successfully saved ${successCount} assets!`, 'success');
                        assetChanges = {};
                    } else {
                        updateAssetStatus(`Saved ${successCount} assets with ${errorCount} errors.`, 'warning');
                    }

                } catch (error) {
                    console.error('Error saving all assets:', error);
                    updateAssetStatus(`Error: ${error.message}`, 'error');
                } finally {
                    saveAllBtn.disabled = false;
                    saveAllBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save All Changes';
                }
            }

            async function updateDeviceProperties(deviceId, properties) {
                // Get the current device
                const devices = await new Promise((resolve, reject) => {
                    api.call('Get', {
                        typeName: 'Device',
                        search: { id: deviceId }
                    }, resolve, reject);
                });

                if (!devices || devices.length === 0) {
                    throw new Error('Device not found');
                }

                const device = devices[0];

                // Map property names to device field names (case-sensitive)
                const propMap = {
                    'bookable': 'Bookable',
                    'recurring': 'AllowRecurringBooking',
                    'approvers': 'Approvers',
                    'fleetManagers': 'FleetManagers',
                    'conflicts': 'AllowConflicts',
                    'windowDays': 'BookingWindowInDays',
                    'maxDurationHours': 'MaximumDurationInHours',
                    'language': 'MailboxLanguage'
                };

                // Update device properties
                for (const [key, value] of Object.entries(properties)) {
                    const deviceFieldName = propMap[key];
                    if (!deviceFieldName) continue;

                    // Set the property value on the device object
                    if (typeof value === 'boolean') {
                        device[deviceFieldName] = value;
                    } else if (typeof value === 'number') {
                        device[deviceFieldName] = value;
                    } else {
                        device[deviceFieldName] = value.toString();
                    }
                }

                // Save the updated device
                await new Promise((resolve, reject) => {
                    api.call('Set', {
                        typeName: 'Device',
                        entity: device
                    }, resolve, reject);
                });
            }

            return {
                initialize: initialize,
                focus: focus,
                blur: blur
            };
        };
        })();
    </script>
</body>
</html>

