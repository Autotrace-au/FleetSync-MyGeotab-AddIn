<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetSync Property Manager</title>
    <style>
        /* Modern CSS with enhanced styling */
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1e40af;
            --primary-light: #3b82f6;
            --success-color: #10b981;
            --success-dark: #059669;
            --warning-color: #f59e0b;
            --warning-dark: #d97706;
            --error-color: #ef4444;
            --error-dark: #dc2626;
            --info-color: #06b6d4;
            --info-dark: #0891b2;
            --secondary-color: #64748b;
            --secondary-dark: #475569;
            --light-bg: #f8fafc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --text-color: #0f172a;
            --text-muted: #64748b;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-color);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 40px;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .subtitle {
            font-size: 16px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .content-wrapper {
            padding: 30px 40px;
        }

        section {
            margin-bottom: 30px;
            padding: 24px;
            background-color: var(--light-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        section:hover {
            box-shadow: var(--shadow-md);
        }

        section h2 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        section h2::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            border-radius: 2px;
        }

        .info-text {
            color: var(--text-muted);
            margin-bottom: 20px;
            line-height: 1.7;
        }

        .status-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-color: #bae6fd;
        }

        .status-message {
            padding: 16px 20px;
            border-radius: 10px;
            font-weight: 500;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-sm);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-message::before {
            font-size: 20px;
            flex-shrink: 0;
        }

        .status-info {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .status-info::before { content: 'ℹ️'; }

        .status-success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .status-success::before { content: '✅'; }

        .status-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .status-warning::before { content: '⚠️'; }

        .status-error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .status-error::before { content: '❌'; }

        .property-list {
            display: grid;
            gap: 16px;
        }

        .property-item {
            display: flex;
            align-items: flex-start;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .property-item:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
            border-color: var(--primary-light);
        }

        .property-icon {
            font-size: 36px;
            margin-right: 18px;
            flex-shrink: 0;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .property-details {
            flex: 1;
        }

        .property-details h3 {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .property-details p {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .property-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background-color: var(--light-bg);
            color: var(--text-muted);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .property-status-badge.status-exists {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border-color: #6ee7b7;
        }

        .property-status-badge.status-missing {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border-color: #fcd34d;
        }

        .actions-section {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            padding: 24px;
            border: 1px solid var(--border-color);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover:not(:disabled)::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: #ffffff;
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-color) 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, var(--success-dark) 100%);
            color: #ffffff;
        }

        .btn-success:hover:not(:disabled) {
            background: linear-gradient(135deg, #34d399 0%, var(--success-color) 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--secondary-dark) 100%);
            color: #ffffff;
        }

        .btn-secondary:hover:not(:disabled) {
            background: linear-gradient(135deg, #94a3b8 0%, var(--secondary-color) 100%);
        }

        .help-section {
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            border-color: #c4b5fd;
        }

        .help-section ul {
            margin-left: 20px;
            margin-top: 12px;
            margin-bottom: 12px;
        }

        .help-section li {
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .help-link {
            margin-top: 16px;
        }

        .help-link a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }

        .help-link a:hover {
            color: var(--primary-dark);
            border-bottom-color: var(--primary-color);
        }

        footer {
            margin-top: 0;
            padding: 24px 40px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            color: var(--text-muted);
            font-size: 12px;
            background-color: var(--light-bg);
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            header {
                padding: 30px 20px;
            }

            .content-wrapper {
                padding: 20px;
            }

            section {
                padding: 16px;
            }

            .property-item {
                flex-direction: column;
                text-align: center;
            }

            .property-icon {
                margin-right: 0;
                margin-bottom: 12px;
            }

            footer {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>FleetSync Property Manager</h1>
            <p class="subtitle">Manage custom properties for FleetSync equipment mailbox automation</p>
        </header>

        <div class="content-wrapper">
            <section class="status-section">
            <h2>Status</h2>
            <div id="statusMessage" class="status-message"></div>
            <div id="propertyStatus" class="property-status"></div>
        </section>

        <section class="properties-section">
            <h2>Required Custom Properties</h2>
            <p class="info-text">
                These custom properties are required by the FleetSync orchestrator to manage Exchange equipment mailboxes.
                Click "Check Properties" to verify which properties exist, then "Create Missing Properties" to add any that are missing.
            </p>

            <div class="property-list">
                <div class="property-item">
                    <div class="property-icon">📋</div>
                    <div class="property-details">
                        <h3>Is this a bookable resource</h3>
                        <p>Boolean (True/False) - Controls whether the equipment mailbox accepts bookings</p>
                        <span class="property-status-badge" data-property="Bookable">Not checked</span>
                    </div>
                </div>

                <div class="property-item">
                    <div class="property-icon">📍</div>
                    <div class="property-details">
                        <h3>Asset Stored Location</h3>
                        <p>Text - Physical location where the asset is stored</p>
                        <span class="property-status-badge" data-property="AssetStoredLocation">Not checked</span>
                    </div>
                </div>

                <div class="property-item">
                    <div class="property-icon">🏭</div>
                    <div class="property-details">
                        <h3>Plant No</h3>
                        <p>Text or Number - Plant or facility identifier</p>
                        <span class="property-status-badge" data-property="PlantNo">Not checked</span>
                    </div>
                </div>

                <div class="property-item">
                    <div class="property-icon">📅</div>
                    <div class="property-details">
                        <h3>Year Purchased</h3>
                        <p>Number - Year the asset was purchased</p>
                        <span class="property-status-badge" data-property="YearPurchased">Not checked</span>
                    </div>
                </div>

                <div class="property-item">
                    <div class="property-icon">🔁</div>
                    <div class="property-details">
                        <h3>Allow Recurring Booking</h3>
                        <p>Boolean (True/False) - Whether recurring bookings are allowed</p>
                        <span class="property-status-badge" data-property="AllowRecurringBooking">Not checked</span>
                    </div>
                </div>

                <div class="property-item">
                    <div class="property-icon">✅</div>
                    <div class="property-details">
                        <h3>Approvers</h3>
                        <p>Text - Comma or semicolon separated email addresses for booking approvers</p>
                        <span class="property-status-badge" data-property="Approvers">Not checked</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="actions-section">
            <button id="checkPropertiesBtn" class="btn btn-primary">
                <span class="btn-icon">🔍</span>
                Check Properties
            </button>
            <button id="createPropertiesBtn" class="btn btn-success" disabled>
                <span class="btn-icon">➕</span>
                Create Missing Properties
            </button>
            <button id="refreshBtn" class="btn btn-secondary">
                <span class="btn-icon">🔄</span>
                Refresh
            </button>
        </section>

        <section class="help-section">
            <h2>About FleetSync</h2>
            <p>
                FleetSync creates and configures Exchange equipment mailboxes for vehicles and trailers, 
                sourced from MyGeotab assets, using an Azure Automation runbook orchestrator so staff can 
                book cars and trailers in Outlook.
            </p>
            <p>
                These custom properties allow the FleetSync orchestrator to:
            </p>
            <ul>
                <li>Control booking availability and permissions</li>
                <li>Set resource location and identification details</li>
                <li>Configure approval workflows</li>
                <li>Manage recurring booking policies</li>
            </ul>
            <p class="help-link">
                For more information, visit the 
                <a href="https://github.com/Autotrace-au/AHC-AssetCreator" target="_blank">FleetSync repository</a>.
            </p>
        </section>
        </div>

        <footer>
            <p>&copy; 2025 Autotrace. All rights reserved.</p>
        </footer>
    </div>

    <script>
        /**
         * FleetSync Property Manager Add-In
         */
        geotab.addin.fleetSyncPropertyManager = () => {
            let api;
            let state;

            const REQUIRED_PROPERTIES = [
                { name: 'Is this a bookable resource', internalName: 'Bookable', description: 'Controls whether the equipment mailbox accepts bookings', dataType: 'Boolean' },
                { name: 'Asset Stored Location', internalName: 'AssetStoredLocation', description: 'Physical location where the asset is stored', dataType: 'String' },
                { name: 'Plant No', internalName: 'PlantNo', description: 'Plant or facility identifier', dataType: 'String' },
                { name: 'Year Purchased', internalName: 'YearPurchased', description: 'Year the asset was purchased', dataType: 'Number' },
                { name: 'Allow Recurring Booking', internalName: 'AllowRecurringBooking', description: 'Whether recurring bookings are allowed', dataType: 'Boolean' },
                { name: 'Approvers', internalName: 'Approvers', description: 'Comma or semicolon separated email addresses for booking approvers', dataType: 'String' }
            ];

            let existingProperties = [];
            let missingProperties = [];

            function initialize(apiInstance, stateInstance, callback) {
                api = apiInstance;
                state = stateInstance;
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', setupEventListeners);
                } else {
                    setupEventListeners();
                }
                callback();
            }

            function focus(apiInstance, stateInstance) {
                api = apiInstance;
                state = stateInstance;
                updateStatus('Ready. Click "Check Properties" to scan for existing custom properties.', 'info');
            }

            function blur(apiInstance, stateInstance) {}

            function setupEventListeners() {
                const checkBtn = document.getElementById('checkPropertiesBtn');
                const createBtn = document.getElementById('createPropertiesBtn');
                const refreshBtn = document.getElementById('refreshBtn');
                if (checkBtn) checkBtn.addEventListener('click', checkProperties);
                if (createBtn) createBtn.addEventListener('click', createMissingProperties);
                if (refreshBtn) refreshBtn.addEventListener('click', refreshPage);
            }

            function updateStatus(message, type = 'info') {
                const statusElement = document.getElementById('statusMessage');
                if (statusElement) {
                    statusElement.textContent = message;
                    statusElement.className = `status-message status-${type}`;
                }
            }

            function updatePropertyBadges() {
                REQUIRED_PROPERTIES.forEach(prop => {
                    const badge = document.querySelector(`[data-property="${prop.internalName}"]`);
                    if (badge) {
                        const exists = existingProperties.some(ep => ep.name.toLowerCase() === prop.name.toLowerCase());
                        if (exists) {
                            badge.textContent = '✓ Exists';
                            badge.className = 'property-status-badge status-exists';
                        } else {
                            badge.textContent = '✗ Missing';
                            badge.className = 'property-status-badge status-missing';
                        }
                    }
                });
            }

            async function checkProperties() {
                updateStatus('Checking existing custom properties...', 'info');
                const checkBtn = document.getElementById('checkPropertiesBtn');
                const createBtn = document.getElementById('createPropertiesBtn');
                if (checkBtn) checkBtn.disabled = true;

                try {
                    const properties = await new Promise((resolve, reject) => {
                        api.call('Get', { typeName: 'Property', search: {} }, resolve, reject);
                    });

                    existingProperties = properties || [];
                    missingProperties = REQUIRED_PROPERTIES.filter(reqProp => {
                        return !existingProperties.some(existProp => existProp.name.toLowerCase() === reqProp.name.toLowerCase());
                    });

                    updatePropertyBadges();

                    if (missingProperties.length === 0) {
                        updateStatus('✓ All required properties exist!', 'success');
                        if (createBtn) createBtn.disabled = true;
                    } else {
                        updateStatus(`Found ${existingProperties.length} properties. ${missingProperties.length} required properties are missing.`, 'warning');
                        if (createBtn) createBtn.disabled = false;
                    }
                } catch (error) {
                    console.error('Error checking properties:', error);
                    updateStatus(`Error: ${error.message || 'Failed to check properties'}`, 'error');
                } finally {
                    if (checkBtn) checkBtn.disabled = false;
                }
            }

            async function createMissingProperties() {
                if (missingProperties.length === 0) {
                    updateStatus('No missing properties to create.', 'info');
                    return;
                }

                updateStatus(`Creating ${missingProperties.length} missing properties...`, 'info');
                const createBtn = document.getElementById('createPropertiesBtn');
                if (createBtn) createBtn.disabled = true;

                let successCount = 0;
                let errorCount = 0;

                try {
                    for (const prop of missingProperties) {
                        try {
                            const propertyEntity = {
                                name: prop.name,
                                description: prop.description,
                                entityTypes: ['Device']
                            };

                            await new Promise((resolve, reject) => {
                                api.call('Add', { typeName: 'Property', entity: propertyEntity }, resolve, reject);
                            });

                            successCount++;
                            console.log(`Created property: ${prop.name}`);
                        } catch (error) {
                            errorCount++;
                            console.error(`Failed to create property ${prop.name}:`, error);
                        }
                    }

                    if (errorCount === 0) {
                        updateStatus(`✓ Successfully created ${successCount} properties!`, 'success');
                    } else {
                        updateStatus(`Created ${successCount} properties with ${errorCount} errors. Check console for details.`, 'warning');
                    }

                    setTimeout(() => checkProperties(), 1000);
                } catch (error) {
                    console.error('Error creating properties:', error);
                    updateStatus(`Error: ${error.message || 'Failed to create properties'}`, 'error');
                }
            }

            function refreshPage() {
                existingProperties = [];
                missingProperties = [];
                const badges = document.querySelectorAll('.property-status-badge');
                badges.forEach(badge => {
                    badge.textContent = 'Not checked';
                    badge.className = 'property-status-badge';
                });
                updateStatus('Ready. Click "Check Properties" to scan for existing custom properties.', 'info');
                const createBtn = document.getElementById('createPropertiesBtn');
                if (createBtn) createBtn.disabled = true;
            }

            return { initialize: initialize, focus: focus, blur: blur };
        };
    </script>
</body>
</html>

